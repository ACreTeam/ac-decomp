#define aNNW_SISTER_STORY_NOW_NUM 3

static u8 sister_story = 0;
static u8 sister_now = 0;

// clang-format off
static u8 aNNW_message_table[24 * aNNW_SISTER_STORY_NOW_NUM] = {
    0x00, 0xFF, 0xFF,
    0x01, 0xFF, 0xFF,
    0x02, 0x20, 0x21,
    0x03, 0x22, 0x23,
    0x04, 0xFF, 0xFF,
    0x05, 0xFF, 0xFF,
    0x06, 0xFF, 0xFF,
    0x07, 0x24, 0xFF,
    0x08, 0xFF, 0xFF,
    0x09, 0x25, 0x26,
    0x0A, 0xFF, 0xFF,
    0x0B, 0xFF, 0xFF,
    0x0C, 0xFF, 0xFF,
    0x0D, 0x27, 0x28,
    0x0E, 0xFF, 0xFF,
    0x0F, 0x29, 0x2A,
    0x10, 0xFF, 0xFF,
    0x11, 0x2B, 0x2C,
    0x13, 0xFF, 0xFF,
    0x14, 0xFF, 0xFF,
    0x15, 0xFF, 0xFF,
    0x16, 0xFF, 0xFF,
    0x17, 0xFF, 0xFF,
    0x18, 0xFF, 0xFF,
};
// clang-format on

static u8 aNNW_story_first_table[4] = { 5, 9, 13, 17 };
static u8 aNNW_story_other_table[4] = { 6, 10, 14, 18 };
static int aNNW_string_table[4] = { 0x06CC, 0x06CB, 0x06CA, 0x06C9 };

static int aNNW_get_sister_message(void) {
    int msg_no;
    
    if (sister_now >= aNNW_SISTER_STORY_NOW_NUM) {
        msg_no = -1;
    } else {
        msg_no = 0x3012 + aNNW_message_table[sister_story * aNNW_SISTER_STORY_NOW_NUM + sister_now];
    }

    return msg_no;
}

static void aNNW_day_day(void) {
    lbRTC_time_c* time_p = Common_GetPointer(time.rtc_time);
    mPr_day_day_c* day_day = &Now_Private->nw_visitor;

    if (Common_Get(player_no) != mPr_FOREIGNER && (time_p->year != day_day->last_date.year || time_p->month != day_day->last_date.month || time_p->day != day_day->last_date.day)) {
        day_day->last_date.year = time_p->year;
        day_day->last_date.month = time_p->month;
        day_day->last_date.day = time_p->day;

        if (day_day->days < aNNW_TALK_DAYS_MAX) {
            day_day->days++;
        }
    }
}

static void aNNW_get_make_sister_message(void) {
    int days;
    int add_day;
    lbRTC_time_c* time_p = Common_GetPointer(time.rtc_time);
    mPr_day_day_c* day_day = &Now_Private->nw_visitor;

    sister_now = 0;
    add_day = 0;
    if (time_p->year != day_day->last_date.year || time_p->month != day_day->last_date.month || time_p->day != day_day->last_date.day) {
        add_day = 1;
    }

    days = day_day->days + add_day;
    if (Common_Get(player_no) == mPr_FOREIGNER) {
        days = 0;
    }

    if (days < 4) {
        sister_story = RANDOM(5);
    } else if (days >= 8) {
        sister_story = 21 + RANDOM(3);
    } else if (add_day == 1) {
        sister_story = aNNW_story_first_table[days - 4];
    } else {
        sister_story = aNNW_story_other_table[days - 4] + RANDOM(3);
    }
}

static int aNNW_get_next_sister_message(void) {
    if (sister_now >= (aNNW_SISTER_STORY_NOW_NUM - 1) || aNNW_message_table[sister_story * aNNW_SISTER_STORY_NOW_NUM + sister_now + 1] == 0xFF) {
        return FALSE;
    }

    return TRUE;
}

static mActor_name_t aNNW_get_sister_name(mActor_name_t name) {
    if (name == SP_NPC_NEEDLEWORK0) {
        return SP_NPC_NEEDLEWORK1;
    } else {
        return SP_NPC_NEEDLEWORK0;
    }
}

static ACTOR* aNNW_search_sister(GAME_PLAY* play, ACTOR* actorx) {
    ACTOR* search;

    for (search = play->actor_info.list[ACTOR_PART_NPC].actor; search != NULL; search = search->next_actor) {
        if (search->id == mAc_PROFILE_NPC_NEEDLEWORK && search != actorx) {
            break;
        }
    }

    return search;
}

static void aNNW_turn_player(ACTOR* actorx) {
    ACTOR* playerx = GET_PLAYER_ACTOR_NOW_ACTOR();

    NPC_CLIP->set_dst_pos_proc((NPC_ACTOR*)actorx, playerx->world.position.x, playerx->world.position.z);
}

static int aNNW_trend_check_cloth(int cloth_idx) {
    Animal_c* animals;
    Animal_c* animal;
    int i;
    int count;

    for (i = 0, animals = Save_Get(animals), count = 0; i < ANIMAL_NUM_MAX; i++) {
        animal = &animals[i];
        if (!mNpc_CheckFreeAnimalPersonalID(&animal->id) && animal->cloth == RSV_CLOTH) {
            int idx = (animal->cloth_original_id & 3);

            if (idx == cloth_idx) {
                count++;
            }
        }
    }

    return count;
}

static void aNNW_trend_delete_cloth(int cloth_idx) {
    Animal_c* animals;
    Animal_c* animal;
    int i;

    for (i = 0, animals = Save_Get(animals); i < ANIMAL_NUM_MAX; i++) {
        animal = &animals[i];
        if (!mNpc_CheckFreeAnimalPersonalID(&animal->id) && animal->cloth == RSV_CLOTH) {
            int idx = (animal->cloth_original_id & 3);

            if (idx == cloth_idx) {
                mNpc_SetDefAnimalCloth(animal);
            }
        }
    }
}

static int aNNW_trend_check_umbrella(int umbrella_idx) {
    int idx;
    Animal_c* animals;
    Animal_c* animal;
    int i;
    int count;

    animals = Save_Get(animals);
    i = 0;
    count = 0;
    idx = (umbrella_idx & 3) + UMBRELLA_NUM;
    umbrella_idx += UMBRELLA_NUM;

    for (i; i < ANIMAL_NUM_MAX; i++) {
        animal = &animals[i];
        if (!mNpc_CheckFreeAnimalPersonalID(&animal->id)) {
            if (animal->umbrella_id == umbrella_idx || animal->umbrella_id == idx) {
                count++;
            }
        }
    }

    return count;
}

static void aNNW_trend_delete_umbrella(int umbrella_idx) {
    int idx;
    Animal_c* animals;
    Animal_c* animal;
    int i;

    animals = Save_Get(animals);
    i = 0;
    idx = (umbrella_idx & 3) + UMBRELLA_NUM;
    umbrella_idx += UMBRELLA_NUM;

    for (i; i < ANIMAL_NUM_MAX; i++) {
        animal = &animals[i];
        if (!mNpc_CheckFreeAnimalPersonalID(&animal->id)) {
            if (animal->umbrella_id == umbrella_idx || animal->umbrella_id == idx) {
                mNpc_SetDefAnimalUmbrella(animal);
            }
        }
    }
}

static int aNNW_first_talk_check(u8 flag) {
    return Common_Get(needlework_first_talk_flags) & flag;
}

static void aNNW_first_talk_end(u8 flag) {
    if (aNNW_first_talk_check(flag) == 0) {
        Common_Get(needlework_first_talk_flags) |= flag;
    }
}

static void aNNW_set_trend_set_string(int trend_idx, int str_no) {
    u8 str[mString_DEFAULT_STR_SIZE];
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();
    
    mString_Load_StringFromRom(str, sizeof(str), aNNW_string_table[trend_idx & 3]);
    mMsg_Set_item_str(msg_p, mMsg_ITEM_STR2 + str_no, str, sizeof(str));
    mMsg_Set_item_str(msg_p, str_no, Save_Get(needlework).original_design[trend_idx & 7].name, sizeof(Save_Get(needlework).original_design[trend_idx & 7].name));
}

static void aNNW_set_trend_cloth_message(void) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();
    int trend_count;
    int trend;
    int i;

    trend = RANDOM(mNW_CLOTH_DESIGN_NUM);
    trend_count = 0;
    for (i = 0; i < mNW_CLOTH_DESIGN_NUM; i++) {
        int count = aNNW_trend_check_cloth(i);

        if (count > trend_count) {
            trend_count = count;
            trend = i;
        }
    }

    aNNW_set_trend_set_string(trend, mMsg_ITEM_STR0);
    if (trend_count == 0) {
        mMsg_Set_continue_msg_num(msg_p, 0x2FDC);
    } else if (trend_count == 1) {
        mMsg_Set_continue_msg_num(msg_p, 0x2FDB);
    } else if (trend_count < 5) {
        mMsg_Set_continue_msg_num(msg_p, 0x2FDA);
    } else {
        mMsg_Set_continue_msg_num(msg_p, 0x2FD9);
    }
}

static void aNNW_set_trend_umbrella_message(void) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();
    int trend_count;
    int trend;
    int i;

    trend = mNW_CLOTH_DESIGN_NUM + RANDOM(mNW_UMBRELLA_DESIGN_NUM);
    trend_count = 0;
    for (i = mNW_CLOTH_DESIGN_NUM; i < (mNW_CLOTH_DESIGN_NUM + mNW_UMBRELLA_DESIGN_NUM); i++) {
        int count = aNNW_trend_check_umbrella(i);

        if (count > trend_count) {
            trend_count = count;
            trend = i;
        }
    }

    aNNW_set_trend_set_string(trend, mMsg_ITEM_STR1);
    if (trend_count == 0) {
        mMsg_Set_continue_msg_num(msg_p, 0x2FE0);
    } else if (trend_count == 1) {
        mMsg_Set_continue_msg_num(msg_p, 0x2FDF);
    } else if (trend_count < 5) {
        mMsg_Set_continue_msg_num(msg_p, 0x2FDE);
    } else {
        mMsg_Set_continue_msg_num(msg_p, 0x2FDD);
    }
}

static void aNNW_change_camera_priority_demo(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    ACTOR* sister_actor = aNNW_search_sister(play, (ACTOR*)actor);
    ACTOR* actorx = (ACTOR*)actor;
    
    Camera2_request_main_needlework_talk(play, sister_actor, actorx, 6);
    if (actorx->npc_id == SP_NPC_NEEDLEWORK0) {
        NPC_CLIP->set_dst_pos_proc((NPC_ACTOR*)actor, sister_actor->world.position.x, sister_actor->world.position.z);
    }
}

static void aNNW_change_camera_return_demo(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    ACTOR* actorx = (ACTOR*)actor;

    Camera2_request_main_talk(play, GET_PLAYER_ACTOR_ACTOR(play), actorx, 6);
    if (actorx->npc_id == SP_NPC_NEEDLEWORK0) {
        aNNW_turn_player(actorx);
    }
}

static void aNNW_set_6_ways(NPC_NEEDLEWORK_ACTOR* actor, mMsg_Window_c* msg_p, int chose_num) {
    switch (chose_num) {
        case mChoice_CHOICE0:
            aNNW_change_talk_proc(actor, aNNW_TALK_DESIGN_CHECK);
            break;
        case mChoice_CHOICE1:
            if (Common_Get(player_no) != mPr_FOREIGNER) {
                aNNW_change_talk_proc(actor, aNNW_TALK_CPORIGINAL0);
            } else {
                aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
                mMsg_Set_continue_msg_num(msg_p, 0x2FEE);
            }
            break;
        case mChoice_CHOICE2:
            aNNW_set_trend_cloth_message();
            aNNW_change_talk_proc(actor, aNNW_TALK_TREND_CLOTH);
            break;
        case mChoice_CHOICE3:
            aNNW_change_talk_proc(actor, aNNW_TALK_CHECK_LISTEN);
            aNNW_first_talk_end(0x40);
            break;
        case mChoice_CHOICE4:
            aNNW_change_talk_proc(actor, aNNW_TALK_OTHER_HAPPEN);
            break;
        case mChoice_CHOICE5:
            aNNW_change_talk_proc(actor, aNNW_TALK_END_WAIT);
            break;
    }
}

static void aNNW_set_5_ways(NPC_NEEDLEWORK_ACTOR* actor, int chose_num) {
    switch (chose_num) {
        case mChoice_CHOICE0:
            aNNW_change_talk_proc(actor, aNNW_TALK_GBA_TOOL_BF);
            break;
        case mChoice_CHOICE1:
            aNNW_change_talk_proc(actor, aNNW_TALK_GBA_LOAD_BF);
            break;
        case mChoice_CHOICE2:
            aNNW_change_talk_proc(actor, aNNW_TALK_CARD_E_LOAD_BF_0);
            break;
        case mChoice_CHOICE3:
            aNNW_change_talk_proc(actor, aNNW_TALK_CARD_E_LOAD_PRG_BF_0);
            break;
        case mChoice_CHOICE4:
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
            break;
        default:
            aNNW_change_talk_proc(actor, aNNW_TALK_END_WAIT);
            break;
    }
}

static void aNNW_talk_what_happen_first(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        aNNW_set_6_ways(actor, msg_p, mChoice_GET_CHOSENUM());
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
    }
}

static void aNNW_talk_what_happen(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        aNNW_set_6_ways(actor, msg_p, mChoice_GET_CHOSENUM());
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
    }
}

static void aNNW_talk_other_happen(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        aNNW_set_5_ways(actor, mChoice_GET_CHOSENUM());
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
    }
}

static void aNNW_talk_other_happen2(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        switch (mChoice_GET_CHOSENUM()) {
            case mChoice_CHOICE0:
                if (Common_Get(player_no) != mPr_FOREIGNER) {
                    aNNW_change_talk_proc(actor, aNNW_TALK_CPORIGINAL0);
                } else {
                    aNNW_change_talk_proc(actor, aNNW_TALK_OTHER_HAPPEN);
                    mMsg_Set_continue_msg_num(msg_p, 0x2FEE);
                }
                break;
            case mChoice_CHOICE1:
                aNNW_change_talk_proc(actor, aNNW_TALK_GBA_WHICH);
                break;
            case mChoice_CHOICE2:
                aNNW_change_talk_proc(actor, aNNW_TALK_END_WAIT);
                break;
        }

        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
    }
}

static void aNNW_talk_check_listen(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        switch (mChoice_GET_CHOSENUM()) {
            case mChoice_CHOICE0:
                aNNW_change_talk_proc(actor, aNNW_TALK_LISTEN_SISTER);
                break;
            case mChoice_CHOICE1:
                aNNW_change_talk_proc(actor, aNNW_TALK_END_WAIT);
                break;
        }

        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
    }
}

static void aNNW_talk_listen_sister(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);

    if (order != 0) {
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
        aNNW_change_talk_proc_next(actor);
        aNNW_change_camera_priority_demo(actor, play);
    }
}

static void aNNW_talk_listen_sister2(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);

    if (order != 0) {
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
        actor->npc_class.actor_class.npc_id = aNNW_get_sister_name(actor->npc_class.actor_class.npc_id);
        aNNW_change_talk_proc_next(actor);
    }
}

static void aNNW_talk_listen_sister3(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);

    if (order != 0) {
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
        actor->npc_class.actor_class.npc_id = aNNW_get_sister_name(actor->npc_class.actor_class.npc_id);
        aNNW_change_talk_proc_next(actor);
    }
}

static void aNNW_talk_listen_sister4(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);

    if (order != 0) {
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
        aNNW_change_talk_proc(actor, aNNW_TALK_END_WAIT);
        aNNW_change_camera_return_demo(actor, play);
    }
}

static void aNNW_talk_design_check(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        switch (mChoice_GET_CHOSENUM()) {
            case mChoice_CHOICE1:
                aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
                break;
            case mChoice_CHOICE0:
                if (mSP_money_check(aNNW_DESIGN_PRICE)) {
                    aNNW_change_talk_proc(actor, aNNW_TALK_DESIGN_WHICH);
                } else {
                    mMsg_Set_continue_msg_num(msg_p, 0x2FE7);
                    aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
                }
                break;
        }

        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
    }
}

static void aNNW_talk_design_which(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);

    if (order != 0 && mMsg_CHECK_MAINNORMALCONTINUE() == TRUE) {
        mMsg_REQUEST_MAIN_DISAPPEAR_WAIT_TYPE1();
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
        aNNW_change_talk_proc(actor, actor->talk_idx + 1);
    }
}

static void aNNW_talk_design_open(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    if (mMsg_CHECK_MAIN_WAIT() == TRUE) {
        Submenu* submenu = &play->submenu;
        int open_type = mNW_OPEN_DESIGN;

        switch (actor->talk_idx) {
            case aNNW_TALK_TRADE_OPEN:
                open_type = mNW_OPEN_INV;
                break;
            case aNNW_TALK_TRADE_OPEN3:
                open_type = mNW_OPEN_CPORIGINAL;
                break;
        }

        mSM_open_submenu_new2(submenu, mSM_OVL_NEEDLEWORK, 0, Common_Get(player_no), NULL, open_type);
        aNNW_change_talk_proc(actor, actor->talk_idx + 1);
    }
}

static void aNNW_talk_design_close(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    Submenu* submenu = &play->submenu;
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (!submenu->open_flag) {
        Submenu_Item_c* sm_item_p = submenu->item_p;

        if (sm_item_p->item == RSV_NO) {
            int slot = sm_item_p->slot_no;

            actor->_9AE = mNW_get_image_no(submenu, slot);
            mSM_open_submenu(submenu, mSM_OVL_DESIGN, slot, 0);
            aNNW_change_talk_proc(actor, aNNW_TALK_DESIGN_CLOSE2);
        } else {
            mMsg_ChangeMsgData(msg_p, 0x2FE9);
            mMsg_Set_ForceNext(msg_p);
            mMsg_request_main_appear_wait_type1(msg_p);
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
        }
    }
}

static void aNNW_talk_design_close2(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    Submenu* submenu = &play->submenu;
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (!submenu->open_flag) {
        Submenu_Item_c* sm_item_p = submenu->item_p;

        if (sm_item_p->slot_no == 1) {
            mMsg_ChangeMsgData(msg_p, 0x2FEA);
            mMsg_Set_ForceNext(msg_p);
            mMsg_request_main_appear_wait_type1(msg_p);
            aNNW_change_talk_proc(actor, aNNW_TALK_DESIGN_CLOSE2_END);
        } else {
            mMsg_ChangeMsgData(msg_p, 0x2FE9);
            mMsg_Set_ForceNext(msg_p);
            mMsg_request_main_appear_wait_type1(msg_p);
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
        }
    }
}

static void aNNW_talk_design_close2_end(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    if (mMsg_CHECK_NOT_SERIES_MAIN_WAIT() == TRUE) {
        aNNW_change_talk_proc(actor, actor->talk_idx + 1);
    }
}

static void aNNW_talk_design_open3(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    if (mMsg_CHECK_MAIN_WAIT() == TRUE) {
        Submenu* submenu = &play->submenu;

        mSM_open_submenu_new(submenu, mSM_OVL_LEDIT, mLE_TYPE_MYORIGINAL_NAME, 0, actor->design_name);
        aNNW_change_talk_proc(actor, aNNW_TALK_DESIGN_CLOSE3);
    }
}

static void aNNW_talk_design_close3(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    Submenu* submenu = &play->submenu;
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (!submenu->open_flag) {
        u16 org_cloth_idx;

        mSP_get_sell_price(aNNW_DESIGN_PRICE);
        mNW_OverWriteOriginalName(&Now_Private->my_org[actor->_9AE & 7], actor->design_name);
        org_cloth_idx = (CLOTH_NUM + 1) + actor->_9AE;
        if (org_cloth_idx == Now_Private->cloth.idx) {
            aNNW_change_talk_proc(actor, aNNW_TALK_CLOTH_CHANGE2);
        } else {
            mMsg_ChangeMsgData(msg_p, 0x2FEB);
            mMsg_Set_ForceNext(msg_p);
            mMsg_request_main_appear_wait_type1(msg_p);
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
        }
    }
}

static void aNNW_talk_trade_check(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);

        switch (mChoice_GET_CHOSENUM()) {
            case mChoice_CHOICE0:
                aNNW_change_talk_proc(actor, aNNW_TALK_GIVE_ADMISSION);
                break;
            case mChoice_CHOICE1:
                aNNW_change_talk_proc(actor, aNNW_TALK_GIVE_ADMISSION2);
                break;
            case mChoice_CHOICE2:
                aNNW_change_talk_proc(actor, aNNW_TALK_TRADE_WHICH);
                break;
            case mChoice_CHOICE3:
                aNNW_change_talk_proc(actor, aNNW_TALK_END_WAIT);
                break;
        }
    }
}

static void aNNW_talk_trade_which(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    if (mMsg_CHECK_MAINNORMALCONTINUE() == TRUE) {
        mMsg_REQUEST_MAIN_DISAPPEAR_WAIT_TYPE1();
        aNNW_change_talk_proc(actor, actor->talk_idx + 1);
    }
}

static void aNNW_talk_trade_close(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    Submenu* submenu = &play->submenu;
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (!submenu->open_flag) {
        Submenu_Item_c* sm_item_p = submenu->item_p;

        if (sm_item_p->item == RSV_NO) {
            u16 org_idx;
            u32 change_idx;

            actor->_9AE = mNW_get_image_no(submenu, sm_item_p->slot_no);
            org_idx = (CLOTH_NUM + 1) + actor->_9AE;
            switch (actor->talk_idx) {
                case aNNW_TALK_TRADE_CLOSE:
                    mMsg_ChangeMsgData(msg_p, 0x2FFA);
                    change_idx = actor->buy_ut_idx;
                    if (change_idx < mNW_CLOTH_DESIGN_NUM) {
                        CLIP(needlework_indoor_clip)->request_exchange_cloth_data_proc(change_idx, actor->_9AE);
                        aNNW_trend_delete_cloth(actor->buy_ut_idx);
                    } else {
                        change_idx -= mNW_CLOTH_DESIGN_NUM;
                        CLIP(needlework_indoor_clip)->request_exchange_umb_data_proc(change_idx, actor->_9AE);
                        aNNW_trend_delete_umbrella(actor->buy_ut_idx - mNW_CLOTH_DESIGN_NUM);
                    }
                    break;
                case aNNW_TALK_TRADE_CLOSE2:
                    mMsg_ChangeMsgData(msg_p, 0x2FF8);
                    change_idx = actor->buy_ut_idx;
                    if (change_idx < mNW_CLOTH_DESIGN_NUM) {
                        CLIP(needlework_indoor_clip)->request_copy_cloth_data_proc(change_idx & 3, &Now_Private->my_org[actor->_9AE & 7]);
                        aNNW_trend_delete_cloth(actor->buy_ut_idx);
                    } else {
                        change_idx -= mNW_CLOTH_DESIGN_NUM;
                        CLIP(needlework_indoor_clip)->request_copy_umb_data_proc(change_idx & 3, &Now_Private->my_org[actor->_9AE & 7]);
                        aNNW_trend_delete_umbrella(actor->buy_ut_idx - mNW_CLOTH_DESIGN_NUM);
                    }
                    break;
                case aNNW_TALK_TRADE_CLOSE3:
                    mMsg_ChangeMsgData(msg_p, 0x2FF9);
                    bcopy(&Save_Get(needlework).original_design[actor->buy_ut_idx & 7], &Now_Private->my_org[actor->_9AE & 7], sizeof(mNW_original_design_c));
                    break;
            }

            if (actor->talk_idx != aNNW_TALK_TRADE_CLOSE2 && org_idx == Now_Private->cloth.idx) {
                aNNW_change_talk_proc(actor, aNNW_TALK_CLOTH_CHANGE);
                return;
            }
        } else {
            mMsg_ChangeMsgData(msg_p, 0x2FF5);
        }
        mMsg_Set_ForceNext(msg_p);
        mMsg_request_main_appear_wait_type1(msg_p);
        aNNW_change_talk_proc(actor, aNNW_TALK_END_WAIT);
    }
}

static void aNNW_talk_give_admission(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);

        switch (mChoice_GET_CHOSENUM()) {
            case mChoice_CHOICE0:
                aNNW_change_talk_proc(actor, actor->talk_idx + 1);
                break;
            case mChoice_CHOICE1:
                aNNW_change_talk_proc(actor, aNNW_TALK_TRADE_WHICH);
                break;
            case mChoice_CHOICE2:
                aNNW_change_talk_proc(actor, aNNW_TALK_END_WAIT);
                break;
        }
    }
}

static void aNNW_talk_gba_which(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);

        switch (mChoice_GET_CHOSENUM()) {
            case mChoice_CHOICE0:
                aNNW_change_talk_proc(actor, aNNW_TALK_GBA_TOOL_BF);
                break;
            case mChoice_CHOICE1:
                aNNW_change_talk_proc(actor, aNNW_TALK_GBA_LOAD_BF);
                break;
            case mChoice_CHOICE2:
                aNNW_change_talk_proc(actor, aNNW_TALK_CARD_E_LOAD_BF_0_0);
                break;
            case mChoice_CHOICE3:
                aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
                break;
        }
    }
}

static void aNNW_talk_gba_tool_bf(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p(); // @unused

    if (order != 0 && mMsg_CHECK_MAINNORMALCONTINUE() == TRUE) {
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
        sAdo_SysLevStart(NA_SE_47);
        mMsg_SET_LOCKCONTINUE();
        aNNW_change_talk_proc_next(actor);
        aNNW_gba_init();
        aNNW_gba_trance_data_init(&play->submenu);
    }
}

static void aNNW_talk_gba_tool(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    switch (aNNW_check_GBA(&actor->gba_ready)) {
        case aNNW_GBA_STATE_TRANSMITTING:
            break;
        case aNNW_GBA_STATE_READY:
            switch (actor->talk_idx) {
                case aNNW_TALK_GBA_TOOL:
                    aNNW_change_talk_proc_next(actor);
                    break;
                default:
                    aNNW_change_talk_proc_next(actor);
                    break;
            }
            break;
        case aNNW_GBA_STATE_NOT_CONNECTED:
            if (actor->gba_wait_frames < 5) {
                actor->gba_wait_frames++;
            } else {
                sAdo_SysLevStop(NA_SE_47);
                mMsg_UNSET_LOCKCONTINUE();
                mMsg_Set_continue_msg_num(msg_p, 0x3008);
                aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
                mGcgba_EndComm();
            }
            break;
    }
}

static void aNNW_talk_gba_tool_0(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    switch (aNNW_IsEditor(&actor->gba_ready)) {
        case aNNW_GBA_STATE_TRANSMITTING:
            break;
        case aNNW_GBA_STATE_READY:
            aNNW_change_talk_proc(actor, aNNW_TALK_GBA_OVER_SAVE);
            sAdo_SysLevStop(NA_SE_47);
            mMsg_UNSET_LOCKCONTINUE();
            mMsg_Set_continue_msg_num(msg_p, 0x2FFD);
            mGcgba_EndComm();
            break;
        case aNNW_GBA_STATE_NOT_CONNECTED:
        case aNNW_GBA_STATE_EDITOR_READY:
            aNNW_change_talk_proc_next(actor);
            break;
    }
}

static void aNNW_talk_gba_tool_af(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    switch (aNNW_mGcgba_boot(&actor->gba_ready)) {
        case aNNW_GBA_STATE_TRANSMITTING:
            break;
        case aNNW_GBA_STATE_READY:
            aNNW_change_talk_proc(actor, aNNW_TALK_GBA_TOOL_AF2);
            break;
        case aNNW_GBA_STATE_NOT_CONNECTED:
            sAdo_SysLevStop(NA_SE_47);
            mMsg_UNSET_LOCKCONTINUE();
            mMsg_Set_continue_msg_num(msg_p, 0x300A);
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
            mGcgba_EndComm();
            break;
    }
}

static void aNNW_talk_gba_tool_af2(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    switch (aNNW_SendPrg(&actor->gba_ready)) {
        case aNNW_GBA_STATE_TRANSMITTING:
            break;
        case aNNW_GBA_STATE_READY:
            aNNW_change_talk_proc(actor, aNNW_TALK_GBA_TOOL_AF3);
            break;
        case aNNW_GBA_STATE_NOT_CONNECTED:
            sAdo_SysLevStop(NA_SE_47);
            mMsg_UNSET_LOCKCONTINUE();
            mMsg_Set_continue_msg_num(msg_p, 0x300A);
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
            mGcgba_EndComm();
            break;
    }
}

static void aNNW_talk_gba_tool_af3(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    switch (aNNW_SendData(&actor->gba_ready)) {
        case aNNW_GBA_STATE_TRANSMITTING:
            break;
        case aNNW_GBA_STATE_READY:
            sAdo_SysLevStop(NA_SE_47);
            mMsg_UNSET_LOCKCONTINUE();
            mMsg_SET_CONTINUE_MSG_NUM(0x300B);
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
            mGcgba_EndComm();
            break;
        case aNNW_GBA_STATE_NOT_CONNECTED:
            sAdo_SysLevStop(NA_SE_47);
            mMsg_UNSET_LOCKCONTINUE();
            mMsg_Set_continue_msg_num(msg_p, 0x300A);
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
            mGcgba_EndComm();
            break;
    }
}

static void aNNW_talk_gba_load_bf(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p(); // @unused

    if (order != 0 && mMsg_CHECK_MAINNORMALCONTINUE() == TRUE) {
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
        sAdo_SysLevStart(NA_SE_47);
        mMsg_SET_LOCKCONTINUE();
        aNNW_change_talk_proc_next(actor);
        aNNW_gba_init();
        aNNW_gba_trance_data_clear();
    }
}

static void aNNW_talk_gba_load_check(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    switch (aNNW_IsEditor(&actor->gba_ready)) {
        case aNNW_GBA_STATE_TRANSMITTING:
            break;
        case aNNW_GBA_STATE_READY:
            aNNW_change_talk_proc(actor, aNNW_TALK_GBA_LOAD_AF);
            break;
        case aNNW_GBA_STATE_EDITOR_READY:
            sAdo_SysLevStop(NA_SE_47);
            mMsg_UNSET_LOCKCONTINUE();
            mMsg_Set_continue_msg_num(msg_p, 0x300D);
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
            mGcgba_EndComm();
            break;
        case aNNW_GBA_STATE_NOT_CONNECTED:
            sAdo_SysLevStop(NA_SE_47);
            mMsg_UNSET_LOCKCONTINUE();
            mMsg_Set_continue_msg_num(msg_p, 0x300E);
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
            mGcgba_EndComm();
            break;
    }
}

static void aNNW_talk_gba_load_af(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    switch (aNNW_RecvData(&actor->gba_ready)) {
        case aNNW_GBA_STATE_READY:
            aNNW_gba_trance_data_end(&play->submenu);
            sAdo_SysLevStop(NA_SE_47);
            mMsg_UNSET_LOCKCONTINUE();
            mMsg_REQUEST_MAIN_DISAPPEAR_WAIT_TYPE1();
            aNNW_change_talk_proc(actor, aNNW_TALK_GBA_MENU0);
            mGcgba_EndComm();
            break;
        case aNNW_GBA_STATE_NOT_CONNECTED:
            sAdo_SysLevStop(NA_SE_47);
            mMsg_UNSET_LOCKCONTINUE();
            mMsg_Set_continue_msg_num(msg_p, 0x300E);
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
            mGcgba_EndComm();
            break;
    }
}

static void aNNW_talk_trend_cloth(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        aNNW_set_trend_umbrella_message();
        mMsg_Set_ForceNext(msg_p);
        aNNW_change_talk_proc(actor, aNNW_TALK_END_WAIT);
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
    }
}

static void aNNW_talk_byebye(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (mMsg_Check_idling_now(msg_p) == TRUE) {
        mMsg_request_main_disappear_wait_type1(msg_p);
        aNNW_change_talk_proc(actor, aNNW_TALK_EXIT);
    }
}

static void aNNW_talk_exit(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (mMsg_Check_main_wait(msg_p) == TRUE) {
        goto_other_scene(play, Common_GetPointer(structure_exit_door_data), TRUE);
        if (play->fb_wipe_mode == WIPE_MODE_NONE) {
            mBGMPsComp_scene_mode(14);
            mBGMPsComp_volume_talk_end();
            mBGMPsComp_make_ps_wipe(0x195);
        }
    }
}

static void aNNW_talk_cloth_change(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    if (mPlib_get_player_actor_main_index((GAME*)play) != mPlayer_INDEX_CHANGE_CLOTH) {
        mPlib_request_main_change_cloth_forNPC_type1((GAME*)play, RSV_CLOTH, Now_Private->cloth.idx, TRUE);
        aNNW_change_talk_proc_next(actor);
    }
}

static void aNNW_talk_cloth_wait(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (mPlib_get_player_actor_main_index((GAME*)play) != mPlayer_INDEX_CHANGE_CLOTH) {
        mMsg_Set_ForceNext(msg_p);
        mMsg_request_main_appear_wait_type1(msg_p);

        switch (actor->talk_idx) {
            case aNNW_TALK_CLOTH_WAIT2:
                mMsg_ChangeMsgData(msg_p, 0x2FEB);
                aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
                break;
            case aNNW_TALK_CLOTH_WAIT3:
                mMsg_Set_continue_msg_num(msg_p, 0x2FF0);
                aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
                break;
            case aNNW_TALK_CLOTH_WAIT4:
                mMsg_SET_CONTINUE_MSG_NUM(0x300F);
                aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
                break;
            default:
                aNNW_change_talk_proc(actor, aNNW_TALK_END_WAIT);
                break;
        }
    }
}

static void aNNW_talk_card_e_load_prg_bf_0(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p(); // @unused

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
        sAdo_SysLevStart(NA_SE_47);
        mMsg_Set_LockContinue(msg_p);
        aNNW_change_talk_proc_next(actor);
        aNNW_gba_init();
    }
}

static void aNNW_talk_card_e_load_prg_bf_1(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    switch (aNNW_check_GBA(&actor->gba_ready)) {
        case aNNW_GBA_STATE_TRANSMITTING:
            break;
        case aNNW_GBA_STATE_READY:
            aNNW_change_talk_proc_next(actor);
            break;
        case aNNW_GBA_STATE_NOT_CONNECTED:
            if (actor->gba_wait_frames < 5) {
                actor->gba_wait_frames++;
            } else {
                sAdo_SysLevStop(NA_SE_47);
                mMsg_Unset_LockContinue(msg_p);
                mMsg_Set_continue_msg_num(msg_p, 0x3008);
                aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
                mGcgba_EndComm();
            }
            break;
    }
}

static void aNNW_talk_card_e_load_prg_0(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    switch (aNNW_Send_card_e(&actor->gba_ready)) {
        case GBA2_EAPPLI_SUCCESS:
            sAdo_SysLevStop(NA_SE_47);
            mMsg_Unset_LockContinue(msg_p);
            mMsg_Set_continue_msg_num(msg_p, 0x3010);
            aNNW_change_talk_proc(actor, aNNW_TALK_CARD_E_LOAD_PRG_AF);
            mGcgba_EndComm();
            break;
        case GBA2_EAPPLI_FAILURE_XFER_ERROR:
        case GBA2_EAPPLI_FAILURE_NO_GBA:
            sAdo_SysLevStop(NA_SE_47);
            mMsg_Unset_LockContinue(msg_p);
            mMsg_Set_continue_msg_num(msg_p, 0x3003);
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
            mGcgba_EndComm();
            break;
    }
}

static void aNNW_talk_card_e_load_prg_af(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);

        switch (mChoice_GET_CHOSENUM()) {
            case mChoice_CHOICE0:
                aNNW_change_talk_proc(actor, aNNW_TALK_CARD_E_LOAD_BF_0);
                break;
            case mChoice_CHOICE1:
                aNNW_change_talk_proc(actor, aNNW_TALK_OTHER_HAPPEN);
                break;
            case mChoice_CHOICE2:
                aNNW_change_talk_proc(actor, aNNW_TALK_END_WAIT);
                break;
        }
    }
}

static void aNNW_talk_card_e_load_bf_0_0(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        switch (mChoice_GET_CHOSENUM()) {
            case mChoice_CHOICE0:
                aNNW_change_talk_proc(actor, aNNW_TALK_CARD_E_LOAD_BF_0);
                break;
            case mChoice_CHOICE1:
                aNNW_change_talk_proc(actor, aNNW_TALK_CARD_E_LOAD_PRG_BF_0);
                break;
        }
    }
}

static void aNNW_talk_card_e_load_bf_0(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
        sAdo_SysLevStart(NA_SE_47);
        mMsg_Set_LockContinue(msg_p);
        aNNW_change_talk_proc_next(actor);
        aNNW_gba_init();
    }
}

static void aNNW_talk_card_e_load_bf_1(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    switch (aNNW_check_GBA(&actor->gba_ready)) {
        case aNNW_GBA_STATE_TRANSMITTING:
            break;
        case aNNW_GBA_STATE_READY:
            aNNW_change_talk_proc_next(actor);
            break;
        case aNNW_GBA_STATE_NOT_CONNECTED:
            if (actor->gba_wait_frames < 5) {
                actor->gba_wait_frames++;
            } else {
                sAdo_SysLevStop(NA_SE_47);
                mMsg_Unset_LockContinue(msg_p);
                mMsg_Set_continue_msg_num(msg_p, 0x3008);
                aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
                mGcgba_EndComm();
            }
            break;
    }
}

static void aNNW_talk_card_e_load(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    switch (aNNW_RecvData_card_e(&actor->gba_ready)) {
        case aNNW_GBA_STATE_READY:
            sAdo_SysLevStop(NA_SE_47);
            mMsg_request_main_disappear_wait_type1(msg_p);
            aNNW_change_talk_proc(actor, aNNW_TALK_CARD_E_MENU0);
            mGcgba_EndComm();
            break;
        case aNNW_GBA_STATE_NOT_CONNECTED:
            sAdo_SysLevStop(NA_SE_47);
            mMsg_Unset_LockContinue(msg_p);
            mMsg_Set_continue_msg_num(msg_p, 0x3002);
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
            mGcgba_EndComm();
            break;
    }
}

static void aNNW_talk_cporiginal0(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        mMsg_REQUEST_MAIN_DISAPPEAR_WAIT_TYPE1();
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
        aNNW_change_talk_proc(actor, actor->talk_idx + 1);
    }
}

static void aNNW_talk_cporiginal1(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();
    Submenu* submenu = &play->submenu;

    if (mMsg_Check_main_wait(msg_p) == TRUE) {
        mSM_open_submenu(submenu, mSM_OVL_NEEDLEWORK, mNW_OPEN_CPORIGINAL, 0);
        aNNW_change_talk_proc(actor, actor->talk_idx + 1);
    }
}

static void aNNW_talk_cporiginal2(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();
    Submenu* submenu = &play->submenu;

    if (!submenu->open_flag) {
        if (mCO_get_change_flg()) {
            aNNW_change_talk_proc(actor, aNNW_TALK_CLOTH_CHANGE3);
        } else {
            mMsg_Set_continue_msg_num(msg_p, 0x2FF0);
            mMsg_request_main_appear_wait_type1(msg_p);
            mMsg_Set_ForceNext(msg_p);
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
        }
    }
}

static void aNNW_talk_gba_menu0(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();
    Submenu* submenu = &play->submenu;

    if (mMsg_Check_main_wait(msg_p) == TRUE) {
        aNNW_gba_open_submenu(submenu);
        aNNW_change_talk_proc(actor, actor->talk_idx + 1);
    }
}

static void aNNW_talk_gba_menu1(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();
    Submenu* submenu = &play->submenu;

    if (!submenu->open_flag) {
        if (mGB_get_change_flg()) {
            aNNW_change_talk_proc(actor, aNNW_TALK_CLOTH_CHANGE4);
        } else {
            mMsg_SET_CONTINUE_MSG_NUM(0x300F);
            mMsg_request_main_appear_wait_type1(msg_p);
            mMsg_Set_ForceNext(msg_p);
            aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
        }
    }
}

static void aNNW_talk_card_e_menu0(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();
    Submenu* submenu = &play->submenu;

    if (mMsg_Check_main_wait(msg_p) == TRUE) {
        aNNW_gba_open_submenu_card_e(submenu);
        aNNW_change_talk_proc_next(actor);
    }
}
static void aNNW_talk_card_e_menu1(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();
    Submenu* submenu = &play->submenu;

    if (!submenu->open_flag) {
        mMsg_Set_continue_msg_num(msg_p, 0x3010);
        mMsg_request_main_appear_wait_type1(msg_p);
        aNNW_change_talk_proc_next(actor);
    }
}

static void aNNW_talk_card_e_menu2(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (mMsg_Check_not_series_main_wait(msg_p) == TRUE) {
        mMsg_Unset_LockContinue(msg_p);
        mMsg_Set_ForceNext(msg_p);
        aNNW_change_talk_proc(actor, aNNW_TALK_CARD_E_LOAD_PRG_AF);
    }
}

static void aNNW_talk_ane_0(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        mDemo_Set_talk_return_demo_wait(TRUE);
        mMsg_request_main_disappear_wait_type1(msg_p);
        aNNW_change_talk_proc(actor, aNNW_TALK_ANE_1);
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
    }
}

static void aNNW_talk_ane_1(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (mMsg_Check_main_wait(msg_p) == TRUE) {
        NPC_NEEDLEWORK_ACTOR* sister;

        mMsg_request_main_forceoff();
        aNNW_change_talk_proc(actor, aNNW_TALK_END_WAIT);
        sister = (NPC_NEEDLEWORK_ACTOR*)aNNW_search_sister(play, (ACTOR*)actor);
        sister->sister_state++;
        actor->sister_state++;
        mDemo_KeepCamera(CAMERA2_PROCESS_TALK);
        sister_now++;
        
        if (actor->npc_class.actor_class.npc_id == SP_NPC_NEEDLEWORK1 && aNNW_get_next_sister_message()) {
            actor->think_idx_after_talk = aNNW_THINK_AINOTE3;
        }
    }
}

static void aNNW_talk_ane_2(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    ACTOR* actorx = (ACTOR*)actor;

    if (mDemo_CAN_ACTOR_TALK(actorx)) {
        NPC_NEEDLEWORK_ACTOR* sister;

        sister = (NPC_NEEDLEWORK_ACTOR*)aNNW_search_sister(play, actorx);
        sister->sister_state = 0;
        actor->sister_state = 0;
    }
}

static void aNNW_talk_ane_3(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);

    if (order != 0) {
        aNNW_turn_player((ACTOR*)actor);
        aNNW_change_talk_proc(actor, aNNW_TALK_ANE_2);
        Camera2_request_main_talk((GAME_PLAY*)gamePT, GET_PLAYER_ACTOR_NOW_ACTOR(), (ACTOR*)actor, 6);
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);
    }
}

static void aNNW_talk_gba_over_save(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play) {
    int order = mDemo_Get_OrderValue(mDemo_ORDER_NPC0, 9);
    mMsg_Window_c* msg_p = mMsg_Get_base_window_p();

    if (order != 0 && mMsg_Check_MainNormalContinue(msg_p) == TRUE) {
        mDemo_Set_OrderValue(mDemo_ORDER_NPC0, 9, 0);

        switch (mChoice_GET_CHOSENUM()) {
            case mChoice_CHOICE0:
                aNNW_change_talk_proc_next(actor);
                break;
            case mChoice_CHOICE1:
                aNNW_change_talk_proc(actor, aNNW_TALK_WHAT_HAPPEN);
                break;
        }
    }
}

static int aNNW_change_talk_proc(NPC_NEEDLEWORK_ACTOR* actor, u8 talk_idx) {
    actor->talk_idx = talk_idx;
    actor->gba_wait_frames = 0;
    return TRUE;
}

static int aNNW_change_talk_proc_next(NPC_NEEDLEWORK_ACTOR* actor) {
    aNNW_change_talk_proc(actor, actor->talk_idx + 1);
    return TRUE;
}

static void aNNW_set_force_talk_info(ACTOR* actorx) {
    static int force_msg_table[] = { 0x2FD1, 0x2FD2, 0x2FD3, 0x2FF2, 0x2FF3, 0x3034, 0x3035 };
    NPC_NEEDLEWORK_ACTOR* actor = (NPC_NEEDLEWORK_ACTOR*)actorx;
    ACTOR* sisterx;

    mDemo_Set_msg_num(force_msg_table[actor->talk_idx]);
    aNNW_first_talk_end(0x80);
    sisterx = aNNW_search_sister((GAME_PLAY*)gamePT, (ACTOR*)actor);

    switch (actor->talk_idx) {
        case 2:
            aNNW_change_talk_proc(actor, aNNW_TALK_BYEBYE);
            mMsg_SET_IDLING_REQ();
            mDemo_Set_talk_turn(FALSE);
            mDemo_Set_camera(CAMERA2_PROCESS_NORMAL);
            break;
        case 3:
        case 4:
            aNNW_change_talk_proc(actor, aNNW_TALK_TRADE_CHECK);
            mDemo_Set_talk_turn(TRUE);
            mDemo_Set_camera(CAMERA2_PROCESS_TALK);
            break;
        case 5:
            if (aNNW_get_next_sister_message()) {
                aNNW_change_talk_proc(actor, aNNW_TALK_ANE_0);
            } else {
                aNNW_change_talk_proc(actor, aNNW_TALK_ANE_2);
            }

            mDemo_Set_talk_turn(TRUE);
            mDemo_Set_camera(CAMERA2_PROCESS_TALK);
            Camera2_request_main_needlework_talk((GAME_PLAY*)gamePT, sisterx, actorx, 6);
            mDemo_Set_msg_num(aNNW_get_sister_message());
            actor->npc_class.talk_info.turn = aNPC_TALK_TURN_NONE;
            break;
        case 6:
            mDemo_Set_talk_turn(TRUE);
            mDemo_Set_camera(CAMERA2_PROCESS_TALK);
            if (sister_story == 9) {
                aNNW_change_talk_proc(actor, aNNW_TALK_ANE_3);
                NPC_CLIP->set_dst_pos_proc((NPC_ACTOR*)actor, sisterx->world.position.x, sisterx->world.position.z);
            } else {
                aNNW_change_talk_proc(actor, aNNW_TALK_ANE_2);
                Camera2_request_main_talk((GAME_PLAY*)gamePT, GET_PLAYER_ACTOR_NOW_ACTOR(), actorx, 6);
            }

            mDemo_Set_msg_num(aNNW_get_sister_message());
            actor->npc_class.talk_info.turn = aNPC_TALK_TURN_NONE;
            break;
        default:
            aNNW_change_talk_proc(actor, aNNW_TALK_END_WAIT);
            mDemo_Set_talk_turn(TRUE);
            mDemo_Set_camera(CAMERA2_PROCESS_TALK);
            break;
    }
}

static void aNNW_force_talk_request(ACTOR* actorx, GAME* game) {
    NPC_NEEDLEWORK_ACTOR* actor = (NPC_NEEDLEWORK_ACTOR*)actorx;

    if (!actor->_9B3) {
        mDemo_Request(mDemo_TYPE_SPEAK, actorx, aNNW_set_force_talk_info);
    } else {
        actor->_9B3 = FALSE;
    }
}

static void aNNW_set_ane_msg(ACTOR* actorx) {
    NPC_NEEDLEWORK_ACTOR* actor = (NPC_NEEDLEWORK_ACTOR*)actorx;
    int msg_no;
    u8 talk_idx;

    if (CLIP(aprilfool_control_clip) != NULL && !CLIP(aprilfool_control_clip)->talk_chk_proc(SP_NPC_NEEDLEWORK1)) {
        msg_no = CLIP(aprilfool_control_clip)->get_msg_num_proc(SP_NPC_NEEDLEWORK1, TRUE);
        talk_idx = aNNW_TALK_ANE_2;
    } else {
        aNNW_get_make_sister_message();
        msg_no = aNNW_get_sister_message();
        
        if (aNNW_get_next_sister_message()) {
            talk_idx = aNNW_TALK_ANE_0;
        } else {
            talk_idx = aNNW_TALK_ANE_2;
        }
    }

    aNNW_change_talk_proc(actor, talk_idx);
    mDemo_Set_msg_num(msg_no);
}

static void aNNW_set_norm_talk_info(ACTOR* actorx) {
    NPC_NEEDLEWORK_ACTOR* actor = (NPC_NEEDLEWORK_ACTOR*)actorx;
    int msg_no;
    u8 talk_idx;

    mDemo_Set_talk_turn(TRUE);
    mDemo_Set_camera(CAMERA2_PROCESS_TALK);
    
    if (actor->talk_idx == 2) {
        aNNW_set_ane_msg(actorx);
    } else {
        if (CLIP(aprilfool_control_clip) != NULL && !CLIP(aprilfool_control_clip)->talk_chk_proc(SP_NPC_NEEDLEWORK0)) {
            talk_idx = aNNW_TALK_END_WAIT;
            msg_no = CLIP(aprilfool_control_clip)->get_msg_num_proc(SP_NPC_NEEDLEWORK0, TRUE);
        } else {
            if (aNNW_first_talk_check(0x40)) {
                talk_idx = aNNW_TALK_WHAT_HAPPEN;
                msg_no = 0x3005;
            } else {
                talk_idx = aNNW_TALK_WHAT_HAPPEN_FIRST;
                msg_no = 0x2FD4;
            }

            actor->delay_frames = 10;
        }

        aNNW_change_talk_proc(actor, talk_idx);
        mDemo_Set_msg_num(msg_no);
        aNNW_turn_player(actorx);
    }

    actor->npc_class.talk_info.turn = aNPC_TALK_TURN_NONE;
}

static void aNNW_norm_talk_request(ACTOR* actorx, GAME* game) {
    NPC_NEEDLEWORK_ACTOR* actor = (NPC_NEEDLEWORK_ACTOR*)actorx;

    if (!actor->_9B3) {
        mDemo_Request(mDemo_TYPE_TALK, actorx, aNNW_set_norm_talk_info);
    } else {
        actor->_9B3 = FALSE;
    }
}

static int aNNW_talk_init(ACTOR* actorx, GAME* game) {
    u8 str[ANIMAL_NAME_LEN];
    NPC_NEEDLEWORK_ACTOR* actor = (NPC_NEEDLEWORK_ACTOR*)actorx;
    NPC_NEEDLEWORK_ACTOR* sister;

    actor->npc_class.talk_info.talk_request_proc = (aNPC_TALK_REQUEST_PROC)none_proc1;
    mDemo_Set_ListenAble();
    mDemo_Start(actorx);
    mString_Load_StringFromRom(str, sizeof(str), 0x6D5); // load 'Mabel'
    mMsg_SET_FREE_STR(mMsg_FREE_STR0, str, sizeof(str));
    mString_Load_StringFromRom(str, sizeof(str), 0x6D6); // load 'Sable'
    mMsg_SET_FREE_STR(mMsg_FREE_STR1, str, sizeof(str));
    
    switch (actorx->npc_id) {
        case SP_NPC_NEEDLEWORK0:
            if (actor->talk_idx != aNNW_TALK_ANE_0 && actor->talk_idx != aNNW_TALK_ANE_2) {
                aNNW_turn_player(actorx);
            }
            break;
        case SP_NPC_NEEDLEWORK1:
            sister = (NPC_NEEDLEWORK_ACTOR*)aNNW_search_sister((GAME_PLAY*)game, actorx);
            switch (sister->sister_state) {
                case 0:
                case 2:
                    sister->sister_state++;
                    break;
            }

            aNNW_day_day();
            if (Now_Private->nw_visitor.days >= 5 && Common_Get(player_no) != mPr_FOREIGNER && actor->talk_idx != aNNW_TALK_ANE_3) {
                aNNW_turn_player(actorx);
            }

            if (actor->think_idx == aNNW_THINK_MISIN_WAIT) {
                if (CLIP(misin_clip) != NULL) {
                    CLIP(misin_clip)->request_misin_stop_proc();
                    CLIP(misin_clip)->request_dustcloth_stop_proc();
                }

                actor->_9BB = TRUE;
                actor->npc_class.draw.anim_speed_type = aNPC_ANIM_SPEED_TYPE_LOCKED;
                actor->npc_class.draw.frame_speed = 0.5f;
            }
            break;
    }

    return TRUE;
}

typedef void (*aNNW_TALK_PROC)(NPC_NEEDLEWORK_ACTOR* actor, GAME_PLAY* play);

static int aNNW_talk_end_chk(ACTOR* actorx, GAME* game) {
    static aNNW_TALK_PROC proc[] = {
        aNNW_talk_what_happen_first,
        aNNW_talk_what_happen,
        aNNW_talk_other_happen,
        aNNW_talk_other_happen2,
        aNNW_talk_check_listen,
        aNNW_talk_listen_sister,
        aNNW_talk_listen_sister2,
        aNNW_talk_listen_sister3,
        aNNW_talk_listen_sister4,
        aNNW_talk_ane_0,
        aNNW_talk_ane_1,
        aNNW_talk_ane_2,
        aNNW_talk_design_check,
        aNNW_talk_design_which,
        aNNW_talk_design_open,
        aNNW_talk_design_close,
        aNNW_talk_design_close2,
        aNNW_talk_design_close2_end,
        aNNW_talk_design_which,
        aNNW_talk_design_open3,
        aNNW_talk_design_close3,
        aNNW_talk_trade_check,
        aNNW_talk_trade_which,
        aNNW_talk_design_open,
        aNNW_talk_trade_close,
        aNNW_talk_give_admission,
        aNNW_talk_trade_which,
        aNNW_talk_design_open,
        aNNW_talk_trade_close,
        aNNW_talk_give_admission,
        aNNW_talk_trade_which,
        aNNW_talk_design_open,
        aNNW_talk_trade_close,
        aNNW_talk_gba_which,
        aNNW_talk_gba_tool_bf,
        aNNW_talk_gba_tool,
        aNNW_talk_gba_tool_0,
        aNNW_talk_gba_tool_af,
        aNNW_talk_gba_tool_af2,
        aNNW_talk_gba_tool_af3,
        aNNW_talk_gba_load_bf,
        aNNW_talk_gba_tool,
        aNNW_talk_gba_load_check,
        aNNW_talk_gba_load_af,
        aNNW_talk_trend_cloth,
        aNNW_talk_byebye,
        aNNW_talk_exit,
        aNNW_talk_cloth_change,
        aNNW_talk_cloth_wait,
        aNNW_talk_cloth_change,
        aNNW_talk_cloth_wait,
        aNNW_talk_cloth_change,
        aNNW_talk_cloth_wait,
        aNNW_talk_cloth_change,
        aNNW_talk_cloth_wait,
        aNNW_talk_cporiginal0,
        aNNW_talk_cporiginal1,
        aNNW_talk_cporiginal2,
        aNNW_talk_gba_menu0,
        aNNW_talk_gba_menu1,
        aNNW_talk_ane_3,
        aNNW_talk_gba_over_save,
        aNNW_talk_gba_tool_bf,
        aNNW_talk_gba_tool,
        aNNW_talk_gba_tool_af3,
        (aNNW_TALK_PROC)none_proc1,
        aNNW_talk_card_e_load_bf_0_0,
        aNNW_talk_card_e_load_bf_0,
        aNNW_talk_card_e_load_bf_1,
        aNNW_talk_card_e_load,
        aNNW_talk_card_e_menu0,
        aNNW_talk_card_e_menu1,
        aNNW_talk_card_e_menu2,
        aNNW_talk_card_e_load_prg_bf_0,
        aNNW_talk_card_e_load_prg_bf_1,
        aNNW_talk_card_e_load_prg_0,
        aNNW_talk_card_e_load_prg_af,
    };

    NPC_NEEDLEWORK_ACTOR* actor = (NPC_NEEDLEWORK_ACTOR*)actorx;
    NPC_ACTOR* nactorx = (NPC_ACTOR*)actorx;
    GAME_PLAY* play = (GAME_PLAY*)game;
    int ret;

    ret = FALSE;
    nactorx->movement.mv_add_angl = DEG2SHORT_ANGLE2(11.25f);
    (*proc[actor->talk_idx])(actor, play);

    if (mDemo_CAN_ACTOR_TALK(actorx)) {
        aNNW_setup_think_proc(actor, play, actor->think_idx_after_talk);
        nactorx->talk_info.turn = aNPC_TALK_TURN_NORMAL;
        actor->_9B6 = 0;
        actor->my_proc_idx = aNNW_MY_PROC_WAIT;
        ret = TRUE;

        if (actor->think_idx == aNNW_THINK_TURN && CLIP(misin_clip) != NULL) {
            CLIP(misin_clip)->request_misin_move_proc();
        }
    }

    return ret;
}
