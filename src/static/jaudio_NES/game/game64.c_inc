#include "jaudio_NES/game64_cpp.h"
#include "m_name_table.h"

#include "jaudio_NES/audiowork.h"
#include "jaudio_NES/sub_sys.h"
#include "jaudio_NES/staff.h"
#include "jaudio_NES/kappa.h"
#include "jaudio_NES/rhythm.h"
#include "jaudio_NES/melody.h"

// this needs to not include aram_hp
#include "jaudio_NES/dummyrom.h"

#include "jaudio_NES/dvdthread.h"
#include "jaudio_NES/verysimple.h"
#include "jaudio_NES/neosthread.h"

typedef struct SOU_LEV_ONGEN_DATA {
    u8 _00;
    u8 _01;
    u8 _02;
    u8 _03;
    u32 _04;
    u8 _08;
    u8 _09;
    f32 distance;
    f32 distance2;
} SOU_LEV_ONGEN_DATA;

typedef struct SOU_LS_STACK {
    u8 _0;
    u8 _1;
    u8 _2;
    u8 _3;
    u8 _4;
    u8 _5;
    u8 _6;
    u8 _7;
} SOU_LS_STACK;

typedef struct SOU_LEV_SE {
    u8 _00;
    u8 _01;
    u8 _02;
    u8 _03;
    u8 _04;
    u8 _05;
    u8 _06;
    u8 _07;
    f32 volumeScale;
    f32 _0C;
    u8 pan;
    u8 reverbVolume;
    u8 _12;
    u8 echo;
} SOU_LEV_SE;

typedef struct SOU_ONGEN_ENTRY {
    u32 _00;
    u8 _04;
    u16 _06;
    u8 pan;
    u8 _09;
    u8 _0A;
    f32 distance;
} SOU_ONGEN_ENTRY;

typedef struct SOU_TRG_SE {
    u16 _00;
    u32 _04;
    f32 volume;
    f32 optVolume;
    f32 calcedVolume;
    f32 freqScale;
    u8 pan;
    u8 reverbVolume;
    u8 _1A;
    u8 echo;
    u8 priority;
    u8 _1D;
} SOU_TRG_SE;

typedef struct SOU_SE_FADE {
    u16 _0;
    u16 _2;
    u16 _4;
    u16 _6;
    f32 volumeScale;
} SOU_SE_FADE;

typedef struct SOU_VOICE_SE {
    u8 _00;
    u32 _04;
    f32 _08;
    f32 _0C;
    f32 volumeScale;
    f32 _14;
    f32 _18;
    f32 frequencyScale;
    u8 pan;
    u8 reverbVolume;
} SOU_VOICE_SE;

typedef struct SOU_ROOM_INS {
    u32 _00;
    u8 _04;
    u8 _05;
    u8 _06;
    u8 _07;
} SOU_ROOM_INS;

typedef struct SOU_SYS_LEV {
    u8 _0;
    u8 _1;
    u8 _2;
} SOU_SYS_LEV;

// clang-format off
const u8 SEQ_TABLE[256] = {
    247,  81,  82,  83,
    84,  85,  86,  87,
    88,  89,  90,  91,
    92,  93,  94,  95,
    96,  97,  98,  99,
    100, 101, 102, 103,
    104, 176, 178, 218,
    219, 220, 222, 223,
    224, 225, 226, 227,
    229, 169, 170, 171,
    68, 166,  60,  59,
    168, 177,  74,  62,
    63,  64,  65,  66,
    67, 214, 215, 216,
    217, 228,  57, 231,
    221, 230, 167,  70,
    71,  73,  75,  78,
    79, 105,  58,  69,
    72, 232, 233, 234,
    235, 179,  76, 172,
    173, 174, 175, 247,
    247, 247, 247, 247,
    180, 181, 182, 183,
    184, 185, 186, 187,
    188, 189, 190, 191,
    192, 193, 194, 195,
    196, 197, 198, 199,
    200, 201, 202, 203,
    204, 205, 206, 207,
    208, 209, 210, 211,
    212, 213,  77,  61,
    77,  80, 247, 247,
    111, 112, 113, 114,
    115, 116, 117, 118,
    119, 120, 121, 122,
    123, 124, 125, 126,
    127, 128, 129, 130,
    131, 132, 133, 134,
    135, 136, 137, 138,
    139, 140, 141, 142,
    143, 144, 145, 146,
    147, 148, 149, 150,
    151, 152, 153, 154,
    155, 156, 157, 158,
    159, 160, 161, 162,
    163, 164, 165, 247,
    247, 247, 247, 247,
    247, 247, 247, 247,
    0,   1,   2,   3,
    4,   5,   6,   7,
    8,   9,  10,  11,
    12,  13,  14,  15,
    16,  17,  18,  19,
    20,  21,  22,  23,
    24,  25,  26,  27,
    28,  29,  30,  31,
    32,  33,  34,  35,
    36,  37,  38,  39,
    40,  41,  42,  43,
    44,  45,  46,  47,
    48,  49,  50,  51,
    52,  53,  54,  55,
    56,  57, 236, 237,
    241, 238, 240, 239
};

const u16 SE_FLOOR_DATA[FLOOR_ALL_NUM] = {
    27, 27, 32, 31,
    28, 32, 31, 27,
    27, 28, 29, 29,
    27, 31, 28, 30,
    33, 27, 30, 27,
    32, 32, 31, 28,
    32, 27, 35, 32,
    32, 32, 27, 29,
    31, 32, 28, 28,
    28, 27, 28, 28,
    27, 31, 36, 32,
    28, 27, 33, 27,
    35, 28, 32, 32,
    28, 28, 32, 29,
    28, 33, 27, 32,
    33, 27, 32, 32,
    28, 32, 32, 34,
    32, 32, 27, 32,
    28, 27, 29, 27,
    28, 28, 27, 31,
    28, 31, 28, 32,
    28, 32, 32, 32,
    32, 32, 32, 32,
    32, 32, 32
};

// ATTRIBUTE_ALIGN(4)
const u16 SE_ROOM_INS_DATA[0x11] = {
    0x505, 0x509, 0x50D, 0x511,
    0x515, 0x519, 0x51D, 0x521,
    0x525, 0x529, 0x501, 0x52D,
    0x531, 0x535, 0x539, 0x53D,
    0
};

const u16 SE_ROOM_INS_RANDOM_OFFSET[] = {
    11, 11, 11, 10,
    10, 10, 12, 100,
    20, 100, 45, 10,
    4, 9, 2, 1,
    0
};

const u8 SHIIN2BOIN[] = {
    0,   1,   2,   3,
    4,   5,   1,   2,
    3,   4,   5,   1,
    2,   3,   4,   5,
    1,   2,   3,   4,
    5,   1,   2,   3,
    4,   5,   1,   2,
    3,   4,   5,   1,
    2,   3,   4,   5,
    1,   3,   5,   1,
    2,   3,   4,   5,
    1,  45,   1,   2,
    3,   4,   5,   1,
    2,   3,   4,   5,
    1,   4,   5,   1,
    2,   3,   4,   5,
    1,   2,   3,   4,
    5,   1,   2,   3,
    4,   5,   3,   1,
    3,   5,   0,   0,
    0,   0,   0,   0,
    0,   0
};

const u8 TRGPRIO[] = {
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  50,  50,  50,
    50,  60,  60,  60,
    60,  60,  60,  60,
    60,  70,  70,  70,
    70,  70,  70,  70,
    70,  70,  70,  70,
    70,  70,  70,  70,
    70,  70,  70,  70,
    70,  70,  70,  70
};

const SOU_TRG_SE sou_trg_se_init = {
   0,
   0,
   1.f,
   1.f,
   1.f,
   1.f,
   0x3f,
   0,
   0,
   0,
   0,
   0,
};

const SOU_VOICE_SE sou_voice_se_init = {
    0,
    0,
    1.f,
    1.f,
    1.f,
    1.f,
    1.f,
    1.f,
    0x3f,
    0,
};

const SOU_LEV_SE sou_lev_se_init = {
    0,0,0,0,
    0,0,0,0,
    0.f,
    1.f,
    0x3f,
    0,0,0
};

const SOU_LEV_ONGEN_DATA sou_lev_ongen_data_init = {
    0,0,0,0,
    0,
    0,0,
    9999.f,
    9999.f
};

const SOU_ONGEN_ENTRY sou_ongen_entry_init = {
    0,
    0,
    0,
    0x3f,
    0,
    0, 
    9999.f
};

const SOU_SE_FADE sou_se_fade_init = {
    0,
    0,
    0,
    0,
    1.f
};

SOU_LS_STACK sou_ls_stack[6];
SOU_TRG_SE sou_trg_se[6];
SOU_VOICE_SE sou_voice_se[2];
SOU_LEV_SE sou_lev_se[6];
SOU_LEV_ONGEN_DATA sou_lev_ongen_data[4];
SOU_ONGEN_ENTRY sou_ongen_entry[50];
SOU_ROOM_INS sou_room_ins[50];
SOU_SE_FADE sou_se_fade[16];

const SOU_LS_STACK sou_ls_stack_init = {
    0,0,0,0,
    0,0,0,0
};

const SOU_SYS_LEV sou_sys_lev_init = {
    0,0,0
};

const SOU_ROOM_INS sou_room_ins_init = {
    0,
    0,0,0,0
};

// unused
f32 OCTAVETABLE[] = {
    1.0, 
    1.059463, 
    1.122462, 
    1.189207,
    1.259921,
    1.33484,
    1.414214,
    1.498307,
    1.587401,
    1.681793,
    1.781797,
    1.887749,
};

u16 BGM_MUTE_TABLE_FINE[] = { 
    // clang-format off
    // bitmask for each subtrack to enable, 0 = disabled, 1 = enabled
    0b0000000111100000, // 0x01e0, hour 0
    0b0000110110000000, // 0x0d80, hour 1
    0b0011100000000000, // 0x3800, hour 2
    0b0000010100000000, // 0x0500, hour 3
    0b0000000011100000, // 0x00e0, hour 4
    0b0000000111000000, // 0x01c0, hour 5
    0b0000010111100000, // 0x05e0, hour 6
    0b0011110111000000, // 0x3dc0, hour 7
    0b0000110110000000, // 0x0d80, hour 8
    0b0000110110000000, // 0x0d80, hour 9
    0b0001100000000000, // 0x1800, hour 10
    0b0001110100000000, // 0x1d00, hour 11
    0b0001110110000000, // 0x1d80, hour 12
    0b0001110110000000, // 0x1d80, hour 13
    0b0000000111110000, // 0x01f0, hour 14
    0b0000000011111000, // 0x00f8, hour 15
    0b0000110110000000, // 0x0d80, hour 16
    0b0111110000000000, // 0x7c00, hour 17
    0b1111001000000000, // 0xf200, hour 18
    0b0001110100000000, // 0x1d00, hour 19
    0b0001110100000000, // 0x1d00, hour 20
    0b0000010111100000, // 0x05e0, hour 21
    0b0000110110000000, // 0x0d80, hour 22
    0b0000110111111100, // 0x0dfc, hour 23
    // clang-format on
};

u16 BGM_MUTE_TABLE_SNOW[] = {
    // clang-format off
    // bitmask for each subtrack to enable, 0 = disabled, 1 = enabled
    0b0000001100000010, // 0x0302, hour 0
    0b0000110000100011, // 0x0c23, hour 1
    0b0010000101101110, // 0x216e, hour 2
    0b0000010000001100, // 0x040c, hour 3
    0b0000000000000110, // 0x0006, hour 4
    0b0000000000000110, // 0x0006, hour 5
    0b0000010000000110, // 0x0406, hour 6
    0b0011100000011011, // 0x381b, hour 7
    0b0000100000000011, // 0x0803, hour 8
    0b0000110001100100, // 0x0c64, hour 9
    0b0001000000100000, // 0x1020, hour 10
    0b0001000010000011, // 0x1083, hour 11
    0b0001110000000010, // 0x1c02, hour 12
    0b0001000001001111, // 0x104f, hour 13
    0b0000011100001110, // 0x070e, hour 14
    0b0000011011000000, // 0x06c0, hour 15
    0b0000100000011101, // 0x081d, hour 16
    0b0000000000011011, // 0x001b, hour 17
    0b0010000000100011, // 0x2023, hour 18
    0b0001000000010111, // 0x1017, hour 19
    0b0001100000000011, // 0x1803, hour 20
    0b0000000000000110, // 0x0006, hour 21
    0b0000110000010110, // 0x0c16, hour 22
    0b0000110110000010, // 0x0d82, hour 23
    // clang-format on
};

u16 BGM_MUTE_TABLE_SAKURA[] = {
    // clang-format off
    // bitmask for each subtrack to enable, 0 = disabled, 1 = enabled
    0b0000000011100010, // 0x00e2, hour 0
    0b0000000010100111, // 0x00a7, hour 1
    0b0001000101101110, // 0x116e, hour 2
    0b0000000000011100, // 0x001c, hour 3
    0b0000000000000110, // 0x0006, hour 4
    0b0000000100000110, // 0x0106, hour 5
    0b0000000110001110, // 0x018e, hour 6
    0b0000000111011011, // 0x01db, hour 7
    0b0000000100000111, // 0x0107, hour 8
    0b0000000011111111, // 0x00ff, hour 9
    0b0000000000100100, // 0x0024, hour 10
    0b0000000010000111, // 0x0087, hour 11
    0b0000000000000111, // 0x0007, hour 12
    0b0000110001001111, // 0x0c4f, hour 13
    0b0000000010111110, // 0x00be, hour 14
    0b0000010000011000, // 0x0418, hour 15
    0b0000010001011111, // 0x045f, hour 16
    0b0000000000011011, // 0x001b, hour 17
    0b1100101000000111, // 0xca07, hour 18
    0b0000010100010111, // 0x0517, hour 19
    0b0000000100000111, // 0x0107, hour 20
    0b0000000100000110, // 0x0106, hour 21
    0b0000000110011111, // 0x019f, hour 22
    0b0000000001111011, // 0x007b, hour 23
    // clang-format on
};

u16 BGM_MUTE_TABLE_MUSEUM[] = {
    // clang-format off
    // bitmask for each subtrack to enable, 0 = disabled, 1 = enabled
    0b0000000000000000, // 0x0000 (not in museum)
    0b1111111111101000, // 0xFFE8 (in museum lobby)
    0b1001111111110110, // 0x9ff6 (in museum painting room)
    0b1111111100011010, // 0xff1a (in museum fish room)
    0b1111110111111111, // 0xfdff (in museum insect room)
    0b0110001011111100, // 0x62fc (in museum fossil room)
    // clang-format on
};
#include "../src/static/jaudio_NES/game/game64_dummy.c_inc"
// clang-format on

// sou_ls_stack;
s32 sou_now_spec;
u8 sou_scene_mode;
u8 sou_chime_status;
void (*fatalErrorCallback)();
u8 sou_last_kokoro_counter;
u8 sou_game_frame_counter;
u8 sou_kokoro_toguru;
u16 sou_last_sys_trg_num;
u8 sou_sub_game_flag;
f32 sou_kazaguruma_speed;
u8 sou_NeosBootCheck_ok;
u8 sou_walk_flag;
u8 sou_last_walk_l;
u8 sou_last_walk_r;
u8 sou_player_dash;
f32 sou_player_speed;
u8 sou_voice_se_toguru;
u8 sou_message_speed;
u8 sou_message_status;
u8 sou_last_voice;
u8 sou_voice_effect;
u8 sou_voice_effect_counter;
u8 sou_pause_flag;
u8 sou_metranome_counter;
u16 sou_last_perio;
u16 sou_last_uchiwa;
u8 sou_out_mode;
u8 sou_voice_mode;
u16 sou_kiteki_random;
u16 sou_kiteki_counter;
f32 sou_camera2ground;
u8 sou_now_boin;
u8 sou_now_voice_seq;
u8 sou_nobasu_count;
u8 sou_now_bgm_num;
f32 sou_bgm_vol_move_target;
f32 sou_bgm_vol_move_delta;
f32 sou_bgm1_vol_now;
f32 sou_bgm2_vol_now;
u16 sou_bgm_vol_move_time;
u16 sou_bgm_vol_move_counter;
u16 sou_kisha_angle;
f32 sou_kisha_distance;
u16 sou_kisha_angle2;
f32 sou_kisha_distance2;
u16 sou_kisha_status;
u16 sou_shu_count;
u16 sou_tonton_count;
u8 sou_voice_type;
u8 sou_SE_SENTAKU_KETTEI_timer;
u8 sou_SE_ami_hit_water_timer;
u8 sou_tenki;
u8 sou_now_bgm_fadeout;
u8 sou_se_handle_ready;
u8 sou_voice_handle_ready;
u8 sou_bgm_call_buffer;
u8 sou_bgm_call_buffer_u8;
u16 sou_bgm_call_buffer_u16;
u16 sou_ongenpos_kill_countdown;
f32 sou_chime_volume;
u8 sou_filter_status;
u8 sou_room_type;
u8 sou_museum_type;
u8 sou_internal_filter_status;
u8 sou_se_fadeout_flag;
u8 sou_voice_sad_toguru;
u8 sou_last_voice_toguru;
u8 sou_voice_se_skip;
u8 sou_num2_request;
u8 sou_Na_VoiceSeFlag;
s16 sou_num2_animal_id;
u8 sou_num2_scale;
u8 sou_last_num;
u8 sou_last_num2;
u8 sou_num_org;
u8 sou_num2_org;
u8 sou_num3_org;
SOU_SYS_LEV sou_sys_lev[2];

u8 sou_now_bgm_handle = 1;
f32 SOU_ONGEN_AREA1 = 540.f;
f32 SOU_ONGEN_AREA2 = 533.f;
f32 sou_md_bgm_boost_pasent = 1.f;

u8 audiomemory[0x90000] ATTRIBUTE_ALIGN(32);
s16* SOU_FIR_STATE;
s16 SOU_FIR_STATE_COPY[12];

void Sou_lev_ongen_data_struct_clear() {
    u8 i = 0;
    for (i = 0; i < ARRAY_COUNT(sou_lev_ongen_data); i++) {
        sou_lev_ongen_data[i]._00 = 0;
        sou_lev_ongen_data[i]._01 = 0;
        sou_lev_ongen_data[i]._02 = 0;
        sou_lev_ongen_data[i]._03 = 0;
        sou_lev_ongen_data[i]._04 = 0;
        sou_lev_ongen_data[i]._08 = 0;
        sou_lev_ongen_data[i]._09 = 0;
        sou_lev_ongen_data[i].distance = 9999.f;
        sou_lev_ongen_data[i].distance2 = 9999.f;
    }
    for (i = 0; i < ARRAY_COUNT(sou_ls_stack); i++) {
        sou_ls_stack[i]._0 = 0;
        sou_ls_stack[i]._1 = 0;
        sou_ls_stack[i]._2 = 0;
        sou_ls_stack[i]._3 = 0;
        sou_ls_stack[i]._4 = 0;
        sou_ls_stack[i]._5 = 0;
        sou_ls_stack[i]._6 = 0;
        sou_ls_stack[i]._7 = 0;
    }
    for (i = 0; i < ARRAY_COUNT(sou_lev_se); i++) {
        sou_lev_se[i]._00 = 0;
        sou_lev_se[i]._01 = 0;
        sou_lev_se[i]._02 = 0;
        sou_lev_se[i]._03 = 0;
        sou_lev_se[i]._04 = 0;
        sou_lev_se[i]._05 = 0;
        sou_lev_se[i]._06 = 0;
        sou_lev_se[i]._07 = 0;
        sou_lev_se[i].volumeScale = 0.f;
        sou_lev_se[i]._0C = 1.f;
        sou_lev_se[i].pan = 0x3f;
        sou_lev_se[i].reverbVolume = 0;
        sou_lev_se[i]._12 = 0;
        sou_lev_se[i].echo = 0;
    }
    for (i = 0; i < ARRAY_COUNT(sou_ongen_entry); i++) {
        sou_ongen_entry[i]._00 = 0;
        sou_ongen_entry[i]._04 = 0;
        sou_ongen_entry[i]._06 = 0;
        sou_ongen_entry[i].pan = 0x3f;
        sou_ongen_entry[i]._09 = 0;
        sou_ongen_entry[i]._0A = 0;
        sou_ongen_entry[i].distance = 9999.0f;
    }
}

void Sou_BgmFadeoutEndCheck() {
    if (sou_now_bgm_fadeout && !AG.groups[1].flags.enabled && !AG.groups[3].flags.enabled) {
        sou_now_bgm_num = 0;
        sou_now_bgm_fadeout = FALSE;
    }
}

u8 Sou_BgmTenkiConv(u8 id) {
    Na_BgmMuteClear();
    if (id >= 1 && id <= 24) {
        switch (sou_tenki) {
            case 0: {
                NA_COMMAND_AUDIO_GROUP_SET_APPLY_SUBTRACK_MASK(sou_now_bgm_handle, BGM_MUTE_TABLE_FINE[id - 1]);

                NA_COMMAND_AUDIO_SUBTRACK_SET_MUTE(sou_now_bgm_handle, AUDIOCMD_ALL_SUBTRACKS, TRUE);
            } break;
            case 1: {
                id = 0x45;
            } break;
            case 2: {
                NA_COMMAND_AUDIO_GROUP_SET_APPLY_SUBTRACK_MASK(sou_now_bgm_handle, BGM_MUTE_TABLE_SNOW[id - 1]);
                NA_COMMAND_AUDIO_SUBTRACK_SET_MUTE(sou_now_bgm_handle, AUDIOCMD_ALL_SUBTRACKS, TRUE);
            } break;
            case 3: {
                NA_COMMAND_AUDIO_GROUP_SET_APPLY_SUBTRACK_MASK(sou_now_bgm_handle, BGM_MUTE_TABLE_SAKURA[id - 1]);
                NA_COMMAND_AUDIO_SUBTRACK_SET_MUTE(sou_now_bgm_handle, AUDIOCMD_ALL_SUBTRACKS, TRUE);
            } break;
            case 4:
            default:
                break;
        }
    }
    return id;
}

void Sou_GroupControl(u8 a, u8 pan, f32 volume) {
    u8 i = 0;
    if (volume > 1.f) {
        volume = 1.f;
    }
    NA_COMMAND_AUDIO_GRP_FADE_VOLUME_SCALE(a, volume);
    if (a == 1) {
        sou_bgm1_vol_now = volume;
    }
    if (a == 3) {
        sou_bgm2_vol_now = volume;
    }
    for (i = 0; i < AUDIO_SUBTRACK_NUM; i++) {
        NA_COMMAND_AUDIO_SUBTRACK_SET_PAN(a, i, pan);
    }
}

void Sou_GroupControl_MD(u8 a, u8 pan, f32 volume) {
    u8 i = 0;
    if (volume > 2.25f) {
        volume = 2.25f;
    }
    NA_COMMAND_AUDIO_GRP_FADE_VOLUME_SCALE(a, volume);
    if (a == 1) {
        sou_bgm1_vol_now = volume;
    }
    if (a == 3) {
        sou_bgm2_vol_now = volume;
    }
    for (i = 0; i < AUDIO_SUBTRACK_NUM; i++) {
        NA_COMMAND_AUDIO_SUBTRACK_SET_PAN(a, i, pan);
    }
}

u8 pan_kochou(u8 a, f32 b) {
    s16 v = 0;
    switch (sou_out_mode) {
        case 0: {
            b = b * 1.6f;
        } break;
        case 2: {
            b = b * 0.75f;
        }; break;
        case 1: {
            return a;
        };
    }
    v = (s16)((a - 0x40) * b);
    if (v > 0x3f) {
        v = 0x3f;
    }
    if (v < -0x40) {
        v = -0x40;
    }
    return 0x40 + v;
}

u8 angle2pan(u16 angle, f32 dist) {
    u8 a = 0;
    f32 v = 1.f;
    angle >>= 8;
    if (angle >= 0x40 && angle <= 0xc0) {
        a = 0x80 - (angle - 0x40);
        if (a == 0x80) {
            a = 0x7f;
        }
    } else if (angle >= 0xc1) {
        a = angle - 0xc0;
    } else {
        a = angle + 0x40;
    }
    a = pan_kochou(a, v);
    return a;
}

f32 distance2vol(f32 distance) {
    f32 ret = 0.f;
    if (distance > SOU_ONGEN_AREA1) {
        return 0.f;
    }

    ret = 1.15f - (1.15f / SQ(SOU_ONGEN_AREA1)) * SQ(distance);
    if (ret > 1.5f) {
        if (ret > 1.5f) {
            ret = 1.5f;
        }
        ret = 1.5f;
    }
    return ret;
}

f32 distance2vol4KITEKI(f32 distance) {
    f32 v2 = 0.f;
    if (distance > 320.f) {
        v2 = 1.15f;
    }
    if (distance < 0.f) {
        v2 = 0.f;
    }
    // idk about this constant
    v2 = 1.15f - (1.f / (5287.f - 0.0435f)) * (distance - 320.f);
    return v2;
}

f32 distance2vol4MD(f32 distance) {
    f32 v2 = 0.f;
    if (distance > SOU_ONGEN_AREA2) {
        v2 = 0.f;
    } else {
        v2 = 1.15f - (1.15f / SQ(SOU_ONGEN_AREA2)) * SQ(distance);
    }
    if (v2 > 0.8f) {
        v2 = 0.8f;
    }
    if (v2 < 0.2f) {
        v2 = 0.2f;
    }
    return v2;
}

void Sou_VoiceStart(u8 a, u8 b) {
    NA_COMMAND_AUDIO_SUBTRACK_SET_PORT(4, a, 0, b);
}

void Sou_TrgStart(u16 id, f32 volume, f32 optVolume, f32 freqScale, u8 pan, u8 reverb, f32 distance) {
    u8 r31 = 0;
    u8 r22 = 0;
    u8 i = 0;
    u32 rand = 0;
    u8 port0 = 0;
    u8 port1 = 0;
    u8 r24 = 0;
    u16 r25 = 0;
    u8 r21 = 0;
    u8 r20 = 0;
    u8 r19 = 0;
    u8 r18 = 0;
    switch (id) {
        case 0x61:
        case 0x63:
        case 0x65:
        case 0x67:
        case 0x11e:
        case 0x4028: {
            rand = Nap_GetRandom();
            id = id + (rand & 1);
        } break;
        case 0x3b:
        case 0x13f:
        case 0x43f:
        case 0x501:
        case 0x505:
        case 0x509:
        case 0x50d:
        case 0x511:
        case 0x515:
        case 0x519:
        case 0x51d:
        case 0x521:
        case 0x525:
        case 0x529:
        case 0x531:
        case 0x539:
        case 0x53d: {
            rand = Nap_GetRandom();
            id = id + (rand & 3);
        } break;
    }
    port0 = id;
    r25 = id & 0xf000;
    r24 = r25 >> 12;
    r25 = id & 0xf00;
    port1 = r25 >> 8;
    r21 = r24 & 1;
    r19 = r24 & 2;
    r18 = r24 & 4;
    r20 = r24 & 8;

    if (r21) {
        NA_COMMAND_AUDIO_SUBTRACK_SET_FREQ_SCALE(0, 0xe, freqScale);
        NA_COMMAND_AUDIO_SUBTRACK_SET_PAN(0, 0xe, pan);
        NA_COMMAND_AUDIO_SUBTRACK_REVERB_VOLUME(0, 0xe, reverb);
        NA_COMMAND_AUDIO_SUBTRACK_SET_PORT(0, 0xe, 0, port0);
        NA_COMMAND_AUDIO_SUBTRACK_SET_PORT(0, 0xe, 1, port1);
        return;
    }

    if (r20) {
        for (i = 0; i < 6; i++) {
            if (id == sou_trg_se[i]._00) {
                return;
            }
        }
    }

    for (i = 0; i < 6; i++) {
        if (!sou_trg_se[i]._00) {
            r31 = i;
            i = 6;
            r22 = 1;
        }
    }

    if (r22 == 1) {
        sou_trg_se[r31]._00 = id;
        sou_trg_se[r31].priority = TRGPRIO[port0];
        sou_trg_se[r31]._04 = 1;
        sou_trg_se[r31].volume = volume;
        sou_trg_se[r31].optVolume = optVolume;
        sou_trg_se[r31].freqScale = freqScale;
        sou_trg_se[r31].pan = pan;
        if (reverb) {
            sou_trg_se[r31].reverbVolume = reverb;
        } else {
            if (r19) {
                r25 = (u16)(distance);
                reverb = r25 >> 3;
                if (reverb > 0x32) {
                    reverb = 0x32;
                }
            }
            if (r18 && sou_trg_se[r31].echo) {
                reverb = 0x28;
            } else {
                reverb = 0;
            }
            sou_trg_se[r31].reverbVolume = reverb;
        }
        NA_COMMAND_AUDIO_SUBTRACK_SET_PORT(0, r31, 0, port0);
        NA_COMMAND_AUDIO_SUBTRACK_SET_PORT(0, r31, 1, port1);
        return;
    }
    rand = 0;
    for (i = 0; i < 6; i++) {
        if (sou_trg_se[i]._04 > rand) {
            rand = sou_trg_se[i]._04;
            r31 = i;
        }
    }
    if (TRGPRIO[port0] >= sou_trg_se[r31].priority) {
        sou_trg_se[r31]._00 = id;
        sou_trg_se[r31].priority = TRGPRIO[port0];
        sou_trg_se[r31]._04 = 1;
        sou_trg_se[r31].volume = volume;
        sou_trg_se[r31].optVolume = optVolume;
        sou_trg_se[r31].freqScale = freqScale;
        sou_trg_se[r31].pan = pan;
        NA_COMMAND_AUDIO_SUBTRACK_SET_PORT(0, r31, 0, port0);
        NA_COMMAND_AUDIO_SUBTRACK_SET_PORT(0, r31, 1, port1);
    }
}

void Sou_SpecialRoutine00() {
    u16 r = 0;
    if (sou_kiteki_counter) {
        if (sou_kiteki_counter == 1) {
            r = Nap_GetRandom();
            r >>= 8;
            sou_kiteki_random = r + 0x40;
        }
        if (sou_kiteki_counter == sou_kiteki_random) {
            Na_SysTrgStart(0x4028);
            r = Nap_GetRandom();
            r >>= 7;
            sou_kiteki_random = r + 0x80;
            sou_kiteki_counter = 2;
        }
        sou_kiteki_counter++;
    }
}

void Sou_SpecialRoutine02() {
    if (sou_SE_SENTAKU_KETTEI_timer) {
        sou_SE_SENTAKU_KETTEI_timer++;
    }
    if (sou_SE_SENTAKU_KETTEI_timer == 0x1e) {
        sou_SE_SENTAKU_KETTEI_timer = 0;
    }
}

void Sou_SpecialRoutine03() {
    if (sou_SE_ami_hit_water_timer) {
        sou_SE_ami_hit_water_timer++;
    }
    if (sou_SE_ami_hit_water_timer == 10) {
        sou_SE_ami_hit_water_timer = 0;
    }
}

void Sou_TrgEndCheck() {
    u8 i = 0;
    u8 unused = 0;
    for (i = 0; i < 6; i++) {
        if (sou_trg_se[i]._00) {
            sou_trg_se[i]._04++;
            if (!Nap_ReadSubPort(0, i, 5) && sou_trg_se[i]._1D) {
                sou_trg_se[i]._00 = 0;
                sou_trg_se[i]._04 = 0;
            }
        }
        sou_trg_se[i]._1D = Nap_ReadSubPort(0, i, 5);
    }
}

void Sou_LevStart(u8 index, u8 b) {
    if (b == sou_lev_se[index]._00 || b == sou_lev_se[index]._01 || b == sou_lev_se[index]._02 ||
        b == sou_lev_se[index]._03 || b == sou_lev_se[index]._04 || b == sou_lev_se[index]._05 ||
        b == sou_lev_se[index]._06 || b == sou_lev_se[index]._07) {
        return;
    }

    if (sou_ls_stack[index]._0) {
        if (sou_ls_stack[index]._1) {
            if (sou_ls_stack[index]._2) {
                if (sou_ls_stack[index]._3) {
                } else {
                    sou_ls_stack[index]._3 = b;
                }
            } else {
                sou_ls_stack[index]._2 = b;
            }
        } else {
            sou_ls_stack[index]._1 = b;
        }
    } else {
        sou_ls_stack[index]._0 = b;
    }
}

void Sou_LevStop(u8 index, u8 b) {
    u8 v = 0;
    if (b == sou_ls_stack[index]._0) {
        sou_ls_stack[index]._0 = 0;
        if (sou_ls_stack[index]._1) {
            sou_ls_stack[index]._0 = sou_ls_stack[index]._1;
            sou_ls_stack[index]._1 = sou_ls_stack[index]._2;
            sou_ls_stack[index]._2 = sou_ls_stack[index]._3;
            sou_ls_stack[index]._3 = 0;
        }
    }

    if (b == sou_ls_stack[index]._1) {
        sou_ls_stack[index]._1 = 0;
        if (sou_ls_stack[index]._2) {
            sou_ls_stack[index]._1 = sou_ls_stack[index]._2;
            sou_ls_stack[index]._2 = sou_ls_stack[index]._3;
            sou_ls_stack[index]._3 = 0;
        }
    }

    if (b == sou_ls_stack[index]._2) {
        sou_ls_stack[index]._2 = 0;
        if (sou_ls_stack[index]._3) {
            sou_ls_stack[index]._2 = sou_ls_stack[index]._3;
            sou_ls_stack[index]._3 = 0;
        }
    }

    if (b == sou_ls_stack[index]._3) {
        sou_ls_stack[index]._3 = 0;
    }

    if (b == sou_lev_se[index]._00) {
        sou_lev_se[index]._00 = sou_lev_se[index]._01;
        sou_lev_se[index]._01 = sou_lev_se[index]._02;
        sou_lev_se[index]._02 = sou_lev_se[index]._03;
        sou_lev_se[index]._03 = sou_lev_se[index]._04;
        sou_lev_se[index]._04 = sou_lev_se[index]._05;
        sou_lev_se[index]._05 = sou_lev_se[index]._06;
        sou_lev_se[index]._06 = sou_lev_se[index]._07;
        sou_lev_se[index]._07 = 0;
        NA_COMMAND_AUDIO_SUBTRACK_SET_PORT(0, index + 8, 5, -1);
        if (sou_lev_se[index]._00) {
            v = sou_lev_se[index]._00;
            sou_lev_se[index]._00 = 0;
            Sou_LevStart(index, v);
        }
        return;
    }

    if (b == sou_lev_se[index]._01) {
        sou_lev_se[index]._01 = sou_lev_se[index]._02;
        sou_lev_se[index]._02 = sou_lev_se[index]._03;
        sou_lev_se[index]._03 = sou_lev_se[index]._04;
        sou_lev_se[index]._04 = sou_lev_se[index]._05;
        sou_lev_se[index]._05 = sou_lev_se[index]._06;
        sou_lev_se[index]._06 = sou_lev_se[index]._07;
        sou_lev_se[index]._07 = 0;
        return;
    }

    if (b == sou_lev_se[index]._02) {
        sou_lev_se[index]._02 = sou_lev_se[index]._03;
        sou_lev_se[index]._03 = sou_lev_se[index]._04;
        sou_lev_se[index]._04 = sou_lev_se[index]._05;
        sou_lev_se[index]._05 = sou_lev_se[index]._06;
        sou_lev_se[index]._06 = sou_lev_se[index]._07;
        sou_lev_se[index]._07 = 0;
        return;
    }

    if (b == sou_lev_se[index]._03) {
        sou_lev_se[index]._03 = sou_lev_se[index]._04;
        sou_lev_se[index]._04 = sou_lev_se[index]._05;
        sou_lev_se[index]._05 = sou_lev_se[index]._06;
        sou_lev_se[index]._06 = sou_lev_se[index]._07;
        sou_lev_se[index]._07 = 0;
        return;
    }

    if (b == sou_lev_se[index]._04) {
        sou_lev_se[index]._04 = sou_lev_se[index]._05;
        sou_lev_se[index]._05 = sou_lev_se[index]._06;
        sou_lev_se[index]._06 = sou_lev_se[index]._07;
        sou_lev_se[index]._07 = 0;
        return;
    }

    if (b == sou_lev_se[index]._05) {
        sou_lev_se[index]._05 = sou_lev_se[index]._06;
        sou_lev_se[index]._06 = sou_lev_se[index]._07;
        sou_lev_se[index]._07 = 0;
        return;
    }

    if (b == sou_lev_se[index]._06) {
        sou_lev_se[index]._06 = sou_lev_se[index]._07;
        sou_lev_se[index]._07 = 0;
        return;
    }

    if (b == sou_lev_se[index]._07) {
        sou_lev_se[index]._07 = 0;
        return;
    }
}

void Sou_TrgMake(u8 index) {
    f32 volume = 0.f;
    sou_trg_se[index].calcedVolume = sou_trg_se[index].volume * sou_trg_se[index].optVolume;
    volume = sou_trg_se[index].calcedVolume;
    if (sou_se_fadeout_flag) {
        volume *= sou_se_fade[index].volumeScale;
    }
    NA_COMMAND_AUDIO_SUBTRACK_SET_VOL_SCALE(0, index, volume);
    NA_COMMAND_AUDIO_SUBTRACK_SET_FREQ_SCALE(0, index, sou_trg_se[index].freqScale);
    NA_COMMAND_AUDIO_SUBTRACK_SET_PAN(0, index, sou_trg_se[index].pan);
    NA_COMMAND_AUDIO_SUBTRACK_REVERB_VOLUME(0, index, sou_trg_se[index].reverbVolume);
}

void Sou_VoiceMake(u8 index) {
    sou_voice_se[index].volumeScale = sou_voice_se[index]._08 * sou_voice_se[index]._0C;
    sou_voice_se[index].frequencyScale = sou_voice_se[index]._14 * sou_voice_se[index]._18;
    NA_COMMAND_AUDIO_SUBTRACK_SET_VOL_SCALE(4, index, sou_voice_se[index].volumeScale);
    NA_COMMAND_AUDIO_SUBTRACK_SET_FREQ_SCALE(4, index, sou_voice_se[index].frequencyScale);
    NA_COMMAND_AUDIO_SUBTRACK_SET_PAN(4, index, sou_voice_se[index].pan);
    NA_COMMAND_AUDIO_SUBTRACK_REVERB_VOLUME(4, index, sou_voice_se[index].reverbVolume);
}

void Sou_LevMake(u8 index) {
    u8 unused = 0;
    f32 volume = 0.f;
    if (sou_pause_flag == 1) {
        NA_COMMAND_AUDIO_SUBTRACK_SET_VOL_SCALE(0, index + 8, 0.5f * sou_lev_se[index].volumeScale);
        return;
    }
    volume = sou_lev_se[index].volumeScale;
    if (sou_se_fadeout_flag) {
        volume *= sou_se_fade[index + 8].volumeScale;
    }
    if (sou_lev_se[index]._00 == 77) {
        volume *= sou_kazaguruma_speed;
    }
    NA_COMMAND_AUDIO_SUBTRACK_SET_VOL_SCALE(0, index + 8, volume);
    NA_COMMAND_AUDIO_SUBTRACK_SET_PAN(0, index + 8, sou_lev_se[index].pan);
    if (sou_lev_se[index].echo && sou_lev_se[index]._12) {
        if (sou_scene_mode == 0xf) {
            sou_lev_se[index].reverbVolume = 0;
        } else {
            sou_lev_se[index].reverbVolume = 0x28;
        }
    } else {
        sou_lev_se[index].reverbVolume = 0;
    }
    NA_COMMAND_AUDIO_SUBTRACK_REVERB_VOLUME(0, index + 8, sou_lev_se[index].reverbVolume);
}

void Sou_ChimeMake() {
    if (sou_se_fade[7]._0 || sou_se_fade[7]._4) {
        sou_chime_volume *= sou_se_fade[7].volumeScale;
    }
    NA_COMMAND_AUDIO_SUBTRACK_SET_VOL_SCALE(0, 7, sou_chime_volume);
}

void Sou_LevSet(u8 index) {
    u8 v1 = 0, v2 = 0;
    if (!sou_ls_stack[index]._0) {
        return;
    }
    v1 = sou_ls_stack[index]._0;
    if (!sou_lev_se[index]._00) {
        sou_lev_se[index]._00 = v1;
    } else if (!sou_lev_se[index]._01) {
        sou_lev_se[index]._01 = sou_lev_se[index]._00;
        sou_lev_se[index]._00 = v1;
    } else if (!sou_lev_se[index]._02) {
        sou_lev_se[index]._02 = sou_lev_se[index]._01;
        sou_lev_se[index]._01 = sou_lev_se[index]._00;
        sou_lev_se[index]._00 = v1;
    } else if (!sou_lev_se[index]._03) {
        sou_lev_se[index]._03 = sou_lev_se[index]._02;
        sou_lev_se[index]._02 = sou_lev_se[index]._01;
        sou_lev_se[index]._01 = sou_lev_se[index]._00;
        sou_lev_se[index]._00 = v1;
    } else if (!sou_lev_se[index]._04) {
        sou_lev_se[index]._04 = sou_lev_se[index]._03;
        sou_lev_se[index]._03 = sou_lev_se[index]._02;
        sou_lev_se[index]._02 = sou_lev_se[index]._01;
        sou_lev_se[index]._01 = sou_lev_se[index]._00;
        sou_lev_se[index]._00 = v1;
    } else if (!sou_lev_se[index]._05) {
        sou_lev_se[index]._05 = sou_lev_se[index]._04;
        sou_lev_se[index]._04 = sou_lev_se[index]._03;
        sou_lev_se[index]._03 = sou_lev_se[index]._02;
        sou_lev_se[index]._02 = sou_lev_se[index]._01;
        sou_lev_se[index]._01 = sou_lev_se[index]._00;
        sou_lev_se[index]._00 = v1;
    } else if (!sou_lev_se[index]._06) {
        sou_lev_se[index]._06 = sou_lev_se[index]._05;
        sou_lev_se[index]._05 = sou_lev_se[index]._04;
        sou_lev_se[index]._04 = sou_lev_se[index]._03;
        sou_lev_se[index]._03 = sou_lev_se[index]._02;
        sou_lev_se[index]._02 = sou_lev_se[index]._01;
        sou_lev_se[index]._01 = sou_lev_se[index]._00;
        sou_lev_se[index]._00 = v1;
    } else if (!sou_lev_se[index]._07) {
        sou_lev_se[index]._07 = sou_lev_se[index]._06;
        sou_lev_se[index]._06 = sou_lev_se[index]._05;
        sou_lev_se[index]._05 = sou_lev_se[index]._04;
        sou_lev_se[index]._04 = sou_lev_se[index]._03;
        sou_lev_se[index]._03 = sou_lev_se[index]._02;
        sou_lev_se[index]._02 = sou_lev_se[index]._01;
        sou_lev_se[index]._01 = sou_lev_se[index]._00;
        sou_lev_se[index]._00 = v1;
    }
    v2 = v1 & 0x80;
    sou_lev_se[index]._12 = v2;
    v1 &= 0x7f;
    NA_COMMAND_AUDIO_SUBTRACK_SET_PORT(0, index + 8, 0, v1);
    sou_ls_stack[index]._0 = sou_ls_stack[index]._1;
    sou_ls_stack[index]._1 = sou_ls_stack[index]._2;
    sou_ls_stack[index]._2 = sou_ls_stack[index]._3;
    sou_ls_stack[index]._3 = 0;
}

void Sou_Insect_Lev_Cont() {
    u8 i = 0;
    for (i = 0; i < 50; i++) {
        if (sou_room_ins[i]._04 == sou_room_ins[i]._05) {
            sou_room_ins[i]._00 = 0;
            sou_room_ins[i]._04 = 0;
            sou_room_ins[i]._05 = 0;
            sou_room_ins[i]._06 = 0;
            sou_room_ins[i]._07 = 0;
        } else {
            sou_room_ins[i]._05 = sou_room_ins[i]._04;
        }
    }
}

void Sou_Ongen_Lev_Cont() {
    u8 i = 0;
    u8 j = 0;
    u8 k = 0;
    u8 found = FALSE;
    u8 foundIndex = 0;
    u8 old04 = 0;
    u8 old09 = 0;

    for (i = 0; i < ARRAY_COUNT(sou_ongen_entry); i++) {
        if (sou_ongen_entry[i]._00) {
            for (j = 0; j < ARRAY_COUNT(sou_lev_ongen_data); j++) {
                if (sou_ongen_entry[i]._00 == sou_lev_ongen_data[j]._04) {
                    found = TRUE;
                }
            }

            if (!found) {
                for (j = 0; j < ARRAY_COUNT(sou_lev_ongen_data); j++) {
                    if (!sou_lev_ongen_data[j]._04) {
                        sou_lev_ongen_data[j]._09 = sou_ongen_entry[i]._04;
                        sou_lev_ongen_data[j]._04 = sou_ongen_entry[i]._00;
                        sou_lev_ongen_data[j]._08 = sou_ongen_entry[i]._06;
                        sou_lev_ongen_data[j].distance = sou_ongen_entry[i].distance;
                        sou_lev_se[j].pan = sou_ongen_entry[i].pan;

                        sou_lev_ongen_data[j]._00 = 1;
                        sou_lev_ongen_data[j]._01 = 0;
                        sou_lev_ongen_data[j].distance2 = 9999.f;
                        sou_lev_ongen_data[j]._03 = 0;
                        sou_lev_ongen_data[j]._02 = 0;

                        // exit early
                        j = ARRAY_COUNT(sou_lev_ongen_data);
                    }
                }
            }
        }
    }

    for (i = 0; i < ARRAY_COUNT(sou_ongen_entry); i++) {
        if (sou_ongen_entry[i]._00) {
            if (sou_ongen_entry[i]._09 == sou_ongen_entry[i]._0A) {
                for (j = 0; j < ARRAY_COUNT(sou_lev_ongen_data); j++) {
                    if (sou_lev_ongen_data[j]._04 == sou_ongen_entry[i]._00) {

                        Sou_LevStop((int)j, sou_lev_ongen_data[j]._08);

                        old09 = sou_lev_ongen_data[j]._09;
                        sou_lev_ongen_data[j]._09 = 0;
                        sou_lev_ongen_data[j]._00 = 0;
                        sou_lev_ongen_data[j]._01 = 0;
                        sou_lev_ongen_data[j]._02 = 0;
                        sou_lev_ongen_data[j]._03 = 0;
                        sou_lev_ongen_data[j]._04 = 0;
                        sou_lev_ongen_data[j]._08 = 0;
                        sou_lev_ongen_data[j].distance = 9999.f;
                        sou_lev_ongen_data[j].distance2 = 9999.f;
                        for (k = 0; k < ARRAY_COUNT(sou_lev_ongen_data); k++) {
                            if (sou_lev_ongen_data[k]._09 > old09) {
                                sou_lev_ongen_data[k]._09--;
                            }
                        }

                        // exit early
                        j = ARRAY_COUNT(sou_lev_ongen_data);
                    }
                }
                old04 = sou_ongen_entry[i]._04;
                sou_ongen_entry[i]._04 = 0;
                sou_ongen_entry[i]._00 = 0;
                sou_ongen_entry[i]._06 = 0;
                sou_ongen_entry[i].pan = 0;
                sou_ongen_entry[i]._09 = 0;
                sou_ongen_entry[i]._0A = 0;
                sou_ongen_entry[i].distance = 9999.f;

                for (j = 0; j < ARRAY_COUNT(sou_ongen_entry); j++) {
                    if (sou_ongen_entry[j]._04 > old04) {
                        sou_ongen_entry[j]._04--;
                    }
                }
                return;
            }

            if (sou_ongen_entry[i]._04 < 5 && sou_ongen_entry[i]._04) {
                for (j = 0; j < ARRAY_COUNT(sou_lev_ongen_data); j++) {
                    if (sou_lev_ongen_data[j]._04 == sou_ongen_entry[i]._00) {
                        foundIndex = j;

                        // exit early
                        j = ARRAY_COUNT(sou_lev_ongen_data);
                    }
                }
                sou_lev_ongen_data[foundIndex].distance = sou_ongen_entry[i].distance;
                sou_lev_se[foundIndex].pan = sou_ongen_entry[i].pan;
                sou_lev_ongen_data[foundIndex]._00++;
            }

            sou_ongen_entry[i]._0A = sou_ongen_entry[i]._09;
        }
    }
}

void Sou_Ongen_Lev_Prog(u8 index) {
    u8 unused = 0;
    u8 i = 0;
    u8 t = 0;
    if (sou_pause_flag != 1) {
        if (sou_lev_ongen_data[index]._04 == 0) {
            sou_lev_ongen_data[index]._02 = 0xff;
        }
        if (sou_lev_ongen_data[index]._00 == sou_lev_ongen_data[index]._01) {
            if (sou_lev_ongen_data[index]._02 == 2) {
                sou_lev_ongen_data[index]._02 = 3;
            }
        } else {
            if (sou_lev_ongen_data[index]._02 == 0) {
                sou_lev_ongen_data[index]._02 = 1;
            }
            if (sou_lev_ongen_data[index]._02 >= 3 && (sou_lev_ongen_data[index]._02 <= 6)) {
                sou_lev_ongen_data[index]._02 = 2;
            }
        }

        sou_lev_ongen_data[index]._01 = sou_lev_ongen_data[index]._00;
        if ((sou_lev_ongen_data[index].distance2 <= SOU_ONGEN_AREA1) &&
            (sou_lev_ongen_data[index].distance > SOU_ONGEN_AREA1)) {
            sou_lev_ongen_data[index]._03 = 0;
        }

        if ((sou_lev_ongen_data[index].distance2 > SOU_ONGEN_AREA1) &&
            (sou_lev_ongen_data[index].distance <= SOU_ONGEN_AREA1)) {
            sou_lev_ongen_data[index]._03 = 1;
        }

        sou_lev_ongen_data[index].distance2 = sou_lev_ongen_data[index].distance;
        if ((sou_lev_ongen_data[index]._02 >= 3) && (sou_lev_ongen_data[index]._02 <= 6)) {
            sou_lev_ongen_data[index]._02++;
        }

        if ((sou_lev_ongen_data[index]._02 == 1) && (sou_lev_ongen_data[index]._03 == 1)) {
            Sou_LevStart((int)index, sou_lev_ongen_data[index]._08);
            sou_lev_ongen_data[index]._02 = 2;
        }

        if (sou_lev_ongen_data[index]._02 == 7 || sou_lev_ongen_data[index]._02 == 0xff) {
            Sou_LevStop((int)index, sou_lev_ongen_data[index]._08);
            t = sou_lev_ongen_data[index]._09;
            sou_lev_ongen_data[index]._09 = 0;
            sou_lev_ongen_data[index]._00 = 0;
            sou_lev_ongen_data[index]._01 = 0;
            sou_lev_ongen_data[index]._02 = 0;
            sou_lev_ongen_data[index]._03 = 0;
            sou_lev_ongen_data[index]._04 = 0;
            sou_lev_ongen_data[index]._08 = 0;
            sou_lev_ongen_data[index].distance = 9999.f;
            sou_lev_ongen_data[index].distance2 = 9999.f;
            for (i = 0; i < 4; i++) {
                if (sou_lev_ongen_data[i]._09 > t) {
                    sou_lev_ongen_data[i]._09--;
                }
            }
        }

        if (sou_lev_ongen_data[index]._02 != 0) {
            switch (sou_lev_ongen_data[index]._08) {
                default:
                    sou_lev_se[index].volumeScale = distance2vol(sou_lev_ongen_data[index].distance);
                    break;
                case 78:
                    sou_lev_se[index].volumeScale = distance2vol4MD(sou_lev_ongen_data[index].distance);
                    break;
            }
        }
    }
    return;
}

void Sou_BgmStart(u8 id, u16 fadeTime) {
    sou_now_bgm_num = id;
    if (id == 0) {
        NA_COMMAND_AUDIO_STOP_SEQ(1, 0);
        NA_COMMAND_AUDIO_STOP_SEQ(3, 0);
        return;
    }
    u16 oldBGMHandle = sou_now_bgm_handle;
    sou_now_bgm_handle = (sou_now_bgm_handle == 1) ? 3 : 1;
    if (id >= 0x70 && id <= 0x79) {
        NA_COMMAND_AUDIO_GROUP_SET_PORT(oldBGMHandle, 0, sou_now_bgm_handle);
        NA_COMMAND_AUDIO_GROUP_SET_PORT(oldBGMHandle, 1, SEQ_TABLE[id]);
        Na_BgmMuteClear();
    } else if (id >= 0x53 && id <= 0x57) {
        int bb = (u8)(id - 0x53);
        Na_SysTrgStart(bb + 0x16f);
    } else {
        NA_COMMAND_AUDIO_STOP_SEQ(oldBGMHandle, fadeTime);
        NA_COMMAND_AUDIO_STOP_SEQ(sou_now_bgm_handle, 0);
        id = Sou_BgmTenkiConv(id);
        NA_COMMAND_AUDIO_START_SEQ(sou_now_bgm_handle, SEQ_TABLE[id], fadeTime);
        Na_StaffRollStart(SEQ_TABLE[id]);
        Na_SetKappaSeqHandle(sou_now_bgm_handle);
    }
}

void Sou_BGMVolMove() {
    f32 volume = 0.f;
    f32 unused = 0.f;
    if (sou_bgm_vol_move_time) {
        switch (sou_now_bgm_handle) {
            case 1: {
                if (sou_bgm_vol_move_counter == 0) {
                    sou_bgm_vol_move_time = 0;
                    volume = sou_bgm_vol_move_target;
                } else {
                    if (sou_bgm_vol_move_counter == sou_bgm_vol_move_time && sou_bgm_vol_move_time) {
                        if (sou_bgm_vol_move_target - sou_bgm1_vol_now == 0.f) {
                            sou_bgm_vol_move_delta = 0.f;
                            sou_bgm_vol_move_counter = 1;
                        } else {
                            sou_bgm_vol_move_delta =
                                (sou_bgm_vol_move_target - sou_bgm1_vol_now) / (int)sou_bgm_vol_move_time;
                        }
                    }
                    volume = sou_bgm_vol_move_target + (-(sou_bgm_vol_move_delta * (int)sou_bgm_vol_move_counter));
                    sou_bgm_vol_move_counter--;
                    if (volume > 1.f) {
                        volume = 1.f;
                    }
                }
                if (volume > 1.f) {
                    volume = 1.f;
                }
                if (volume < 0.f) {
                    volume = 0.f;
                }
                sou_bgm1_vol_now = volume;
                NA_COMMAND_AUDIO_GRP_FADE_VOLUME_SCALE(1, volume);
            } break;
            case 3: {
                if (sou_bgm_vol_move_counter == 0) {
                    sou_bgm_vol_move_time = 0;
                    volume = sou_bgm_vol_move_target;
                } else {
                    if (sou_bgm_vol_move_counter == sou_bgm_vol_move_time && sou_bgm_vol_move_time) {
                        if (sou_bgm_vol_move_target - sou_bgm2_vol_now == 0) {
                            sou_bgm_vol_move_delta = 0.f;
                            sou_bgm_vol_move_counter = 1;
                        } else {
                            sou_bgm_vol_move_delta =
                                (sou_bgm_vol_move_target - sou_bgm2_vol_now) / (int)sou_bgm_vol_move_time;
                        }
                    }
                    volume = sou_bgm_vol_move_target + (-(sou_bgm_vol_move_delta * (int)sou_bgm_vol_move_counter));
                    sou_bgm_vol_move_counter--;
                    if (volume > 1.f) {
                        volume = 1.f;
                    }
                }
                if (volume > 1.f) {
                    volume = 1.f;
                }
                if (volume < 0.f) {
                    volume = 0.f;
                }
                sou_bgm2_vol_now = volume;
                NA_COMMAND_AUDIO_GRP_FADE_VOLUME_SCALE(3, volume);
            } break;
        }
    }
}

void Sou_Na_BgmStart(u8 id) {
    u16 param = 0;
    Sou_BgmStart(id, param);
    if (id >= 0x80 && id <= 0xb6) {
        Sou_GroupControl(1, 0x3f, 0.f);
        Sou_GroupControl(3, 0x3f, 0.f);
    }
}

void Sou_Na_BgmStop(u16 id) {
    sou_now_bgm_fadeout = 1;
    id &= 0xfff;
    if (sou_now_bgm_handle == 1) {
        NA_COMMAND_AUDIO_STOP_SEQ(1, id);
    } else {
        NA_COMMAND_AUDIO_STOP_SEQ(3, id);
    }
}

void Sou_SpecialRoutine06() {
    u8 v = 0;
    switch (sou_bgm_call_buffer) {
        case 1: {
            Sou_Na_BgmStart(sou_bgm_call_buffer_u8);
        } break;
        case 2: {
            if (sou_now_bgm_handle == 1) {
                sou_now_bgm_handle = 3;
                NA_COMMAND_AUDIO_STOP_SEQ(1, 700);
                v = Sou_BgmTenkiConv(sou_bgm_call_buffer_u8);
                NA_COMMAND_AUDIO_START_SEQ(3, SEQ_TABLE[v], 700);
            } else {
                sou_now_bgm_handle = 1;
                NA_COMMAND_AUDIO_STOP_SEQ(3, 700);
                v = Sou_BgmTenkiConv(sou_bgm_call_buffer_u8);
                NA_COMMAND_AUDIO_START_SEQ(1, SEQ_TABLE[v], 700);
            }
        } break;
        case 3: {
            Sou_Na_BgmStop(sou_bgm_call_buffer_u16);
        }
    }
}

void Sou_SpecialRoutine07() {
    sou_bgm_call_buffer = 0;
    sou_bgm_call_buffer_u8 = 0;
    sou_bgm_call_buffer_u16 = 0;
}

void Sou_SeFadeoutRoutine() {
    u8 i = 0;
    f32 v1 = 0.f;
    f32 v2 = 0.f;
    for (i = 0; i < ARRAY_COUNT(sou_se_fade); i++) {
        if (sou_se_fade[i]._0 == 0xffff) {
            sou_se_fade[i].volumeScale = 0.f;
            sou_se_fade[i]._0 = 0;
            if (i >= 8 && i <= 14) {
                sou_lev_se[i].volumeScale = 0.f;
            }
        } else if (sou_se_fade[i]._0 != 0) {
            if (sou_se_fade[i]._0 == sou_se_fade[i]._2) {
                sou_se_fade[i].volumeScale = 0.f;
                sou_se_fade[i]._0 = 0xffff;
            } else {
                v1 = sou_se_fade[i]._2 - sou_se_fade[i]._0;
                v2 = sou_se_fade[i]._2;
                sou_se_fade[i].volumeScale = v1 / v2;
                sou_se_fade[i]._0++;
            }
        }
    }
}

void Sou_SeFadeinRoutine() {
    u8 i = 0;
    f32 v1 = 0.f;
    f32 v2 = 0.f;
    for (i = 0; i < ARRAY_COUNT(sou_se_fade); i++) {
        if (sou_se_fade[i]._4 == 0xffff) {
            sou_se_fade[i].volumeScale = 1.f;
            sou_se_fade[i]._4 = 0;
            if (i >= 8 && i <= 14) {
                sou_lev_se[i].volumeScale = 1.f;
            }
        } else if (sou_se_fade[i]._4 != 0) {
            if (sou_se_fade[i]._4 == sou_se_fade[i]._6) {
                sou_se_fade[i].volumeScale = 1.f;
                sou_se_fade[i]._4 = 0xffff;
            } else {
                v1 = sou_se_fade[i]._6 - sou_se_fade[i]._4;
                v2 = sou_se_fade[i]._6;
                sou_se_fade[i].volumeScale = v1 / v2;
                sou_se_fade[i]._4++;
            }
        }
    }
}

void Sou_SeVolumeReset() {
    u8 i = 0;
    for (i = 0; i < ARRAY_COUNT(sou_lev_se); i++) {
        sou_se_fade[i + 8]._0 = 0;
        sou_se_fade[i + 8]._4 = 0;
        sou_lev_se[i].volumeScale = 0.f;
        sou_lev_se[i]._0C = 1.f;
    }
}

void Sou_SeTrFadeout(u8 index, u16 b) {
    sou_se_fade[index]._0 = 1;
    sou_se_fade[index]._2 = b;
}

void Sou_SeFadeout(u16 a) {
    u8 i = 0;
    sou_se_fadeout_flag = 1;
    for (i = 0; i < ARRAY_COUNT(sou_lev_se); i++) {
        Sou_SeTrFadeout(i + 8, a);
    }
}

void Sou_SpecialRoutine08() {
    if (sou_ongenpos_kill_countdown != 0 && sou_ongenpos_kill_countdown != 1) {
        sou_ongenpos_kill_countdown--;
    }
}

void Sou_SpecialRoutine10() {
    if (sou_Na_VoiceSeFlag == 1) {
        sou_Na_VoiceSeFlag = 0;
    } else if (sou_num2_request) {
        Na_VoiceSe(sou_num2_request, 0, 0, sou_num2_animal_id, sou_num2_scale, 2);
        sou_num2_request = 0;
    }
}

void Sou_InitAudio() {
    int i;
    sou_now_spec = 0;
    sou_scene_mode = 0;
    sou_now_bgm_handle = 1;
    sou_chime_status = 0;
    sou_last_kokoro_counter = 0;
    sou_game_frame_counter = 0;
    sou_kokoro_toguru = 0;
    sou_last_sys_trg_num = 0;
    sou_sub_game_flag = 0;
    sou_kazaguruma_speed = 0.f;
    sou_walk_flag = 0;
    sou_last_walk_l = 0;
    sou_last_walk_r = 0;
    sou_player_dash = 0;
    sou_player_speed = 0.f;
    sou_voice_se_toguru = 0;
    sou_message_speed = 0;
    sou_message_status = 0;
    sou_last_voice = 0;
    sou_voice_effect = 0;
    sou_voice_effect_counter = 0;
    sou_pause_flag = 0;
    sou_metranome_counter = 0;
    sou_last_perio = 0;
    sou_last_uchiwa = 0;
    sou_out_mode = 0;
    sou_voice_mode = 0;
    sou_kiteki_random = 0;
    sou_kiteki_counter = 0;
    sou_camera2ground = 0.f;
    sou_now_boin = 0;
    sou_now_voice_seq = 0;
    sou_nobasu_count = 0;
    sou_now_bgm_num = 0;
    sou_bgm_vol_move_target = 0.f;
    sou_bgm_vol_move_delta = 0.f;
    sou_bgm1_vol_now = 0.f;
    sou_bgm2_vol_now = 0.f;
    sou_bgm_vol_move_time = 0;
    sou_bgm_vol_move_counter = 0;
    sou_kisha_angle = 0;
    sou_kisha_distance = 0.f;
    sou_kisha_angle2 = 0;
    sou_kisha_distance2 = 0.f;
    sou_kisha_status = 0;
    sou_shu_count = 0;
    sou_tonton_count = 0;
    sou_voice_type = 0;
    sou_SE_SENTAKU_KETTEI_timer = 0;
    sou_SE_ami_hit_water_timer = 0;
    sou_tenki = 0;
    sou_now_bgm_fadeout = 0;
    sou_se_handle_ready = 0;
    sou_voice_handle_ready = 0;
    sou_bgm_call_buffer = 0;
    sou_bgm_call_buffer_u8 = 0;
    sou_bgm_call_buffer_u16 = 0;
    sou_ongenpos_kill_countdown = 0;
    sou_chime_volume = 0.f;
    sou_filter_status = 0;
    sou_room_type = 0;
    sou_museum_type = 0;
    SOU_ONGEN_AREA1 = 540.f;
    SOU_ONGEN_AREA2 = 533.f;
    sou_md_bgm_boost_pasent = 1.f;
    sou_internal_filter_status = 0;
    sou_se_fadeout_flag = 0;
    sou_voice_sad_toguru = 0;
    sou_last_voice_toguru = 0;
    sou_voice_se_skip = 0;
    sou_num2_request = 0;
    sou_Na_VoiceSeFlag = 0;
    sou_num2_animal_id = 0;
    sou_num2_scale = 0;
    sou_last_num = 0;
    sou_last_num2 = 0;
    sou_num_org = 0;
    sou_num2_org = 0;
    sou_num3_org = 0;
    for (i = 0; i < ARRAY_COUNT(sou_trg_se); i++) {
        sou_trg_se[i] = sou_trg_se_init;
    }
    for (i = 0; i < ARRAY_COUNT(sou_voice_se); i++) {
        sou_voice_se[i] = sou_voice_se_init;
    }
    for (i = 0; i < ARRAY_COUNT(sou_lev_se); i++) {
        sou_lev_se[i] = sou_lev_se_init;
        sou_ls_stack[i] = sou_ls_stack_init;
    }
    for (i = 0; i < ARRAY_COUNT(sou_lev_ongen_data); i++) {
        sou_lev_ongen_data[i] = sou_lev_ongen_data_init;
    }
    for (i = 0; i < ARRAY_COUNT(sou_ongen_entry); i++) {
        sou_ongen_entry[i] = sou_ongen_entry_init;
    }
    for (i = 0; i < ARRAY_COUNT(sou_sys_lev); i++) {
        sou_sys_lev[i] = sou_sys_lev_init;
    }
    for (i = 0; i < ARRAY_COUNT(sou_room_ins); i++) {
        sou_room_ins[i] = sou_room_ins_init;
    }
    for (i = 0; i < ARRAY_COUNT(sou_se_fade); i++) {
        sou_se_fade[i] = sou_se_fade_init;
    }
    NA_COMMAND_AUDIO_START_SEQ(0, 0xf2, 0);
    NA_COMMAND_AUDIO_GRP_FADE_VOLUME_SCALE(0, 1.15f);
    NA_COMMAND_AUDIO_GRP_FADE_VOLUME_SCALE(1, 1.f);
    sou_bgm1_vol_now = 1.f;
    NA_COMMAND_AUDIO_GRP_FADE_VOLUME_SCALE(3, 1.f);
    sou_bgm2_vol_now = 1.f;
    NA_COMMAND_AUDIO_GRP_FADE_VOLUME_SCALE(2, 1.f);
    Na_Pause(0);
    Na_BGMVolume(1.f, 2);
    Na_RhythmInit();
    Na_MelodyInit();
    Na_StaffRollInit();
}

void Sou_DVD_Error(char*, u8*) {
    fatalErrorCallback();
}

void Na_InitAudio(void (*fatal_callback)(), u8* load_addr, size_t load_size, u8* bootsound, size_t bootsound_size,
                  BOOL cut_flag) {
    u32 v = 0x810000;
    fatalErrorCallback = fatal_callback;
    u32 unused = SetPreCopy_NeosRom(load_addr, load_size, cut_flag);
    Jac_RegisterDVDErrorCallback(Sou_DVD_Error);
    Jac_Start(audiomemory, sizeof(audiomemory), v);
    BootSound((u32)bootsound, bootsound_size);
    sou_NeosBootCheck_ok = 1;
}

void Na_GameFrame() {
    u8 i = 0;
    sou_game_frame_counter++;
    switch (sou_NeosBootCheck_ok) {
        case 1: {
            if (!Neos_CheckBoot()) {
                return;
            }
            sou_NeosBootCheck_ok = 2;
        }
        // fallthrough
        case 2: {
            Sou_InitAudio();
            sou_NeosBootCheck_ok = 3;
        } break;
        case 3: {
            Sou_BGMVolMove();
            Sou_SeFadeoutRoutine();
            Sou_SeFadeinRoutine();
            Sou_TrgEndCheck();
            for (i = 0; i < ARRAY_COUNT(sou_trg_se); i++) {
                Sou_TrgMake(i);
            }
            for (i = 0; i < ARRAY_COUNT(sou_voice_se); i++) {
                Sou_VoiceMake(i);
            }
            for (i = 0; i < ARRAY_COUNT(sou_lev_se); i++) {
                Sou_LevSet(i);
                Sou_LevMake(i);
            }
            Sou_ChimeMake();
            Sou_Ongen_Lev_Cont();
            Sou_Insect_Lev_Cont();
            for (i = 0; i < ARRAY_COUNT(sou_lev_ongen_data); i++) {
                Sou_Ongen_Lev_Prog(i);
            }
            Sou_BgmFadeoutEndCheck();
            Sou_SpecialRoutine00();
            Sou_SpecialRoutine02();
            Sou_SpecialRoutine03();
            Sou_SpecialRoutine06();
            Sou_SpecialRoutine07();
            Sou_SpecialRoutine08();
            Sou_SpecialRoutine10();
            int unused = Nap_SendStart();
        } break;
        case 0:
        case 4:
        default:
            break;
    }
}

void Na_Reset() {
    int unused = Nap_StartReset();
}

void Na_SoftReset() {
    u8 i = 0;
    sou_pause_flag = 0;
    sou_scene_mode = 0;
    for (i = 0; i < ARRAY_COUNT(sou_sys_lev); i++) {
        sou_sys_lev[i]._0 = 0;
        sou_sys_lev[i]._1 = 0;
    }
    for (i = 0; i < ARRAY_COUNT(sou_ls_stack); i++) {
        sou_ls_stack[i]._0 = 0;
        sou_ls_stack[i]._1 = 0;
        sou_ls_stack[i]._2 = 0;
        sou_ls_stack[i]._3 = 0;
        sou_ls_stack[i]._4 = 0;
        sou_ls_stack[i]._5 = 0;
        sou_ls_stack[i]._6 = 0;
        sou_ls_stack[i]._7 = 0;
    }
    for (i = 0; i < ARRAY_COUNT(sou_lev_se); i++) {
        sou_lev_se[i]._00 = 0;
        sou_lev_se[i]._01 = 0;
        sou_lev_se[i]._02 = 0;
        sou_lev_se[i]._03 = 0;
        sou_lev_se[i]._04 = 0;
        sou_lev_se[i]._05 = 0;
        sou_lev_se[i]._06 = 0;
        sou_lev_se[i]._07 = 0;
    }
    Na_Pause(0);
    NA_COMMAND_AUDIO_STOP_SEQ(0, 180);
    Na_BgmStop(180);
    NA_COMMAND_AUDIO_STOP_SEQ(2, 180);
    NA_COMMAND_AUDIO_STOP_SEQ(4, 180);
    Na_BGMVolume(1.f, 2);
    NA_COMMAND_AUDIO_START_SEQ(0, 0xf2, 0);
    int unused = Nap_SendStart();
}

void Na_Tenki(u8 a) {
    if (a != sou_tenki) {
        sou_tenki = a;
    }
}

void Na_BgmStart(u8 a) {
    u16 unused = 0;

    sou_bgm_call_buffer_u8 = a;
    sou_bgm_call_buffer = 1;
}

void Na_BgmCrossfadeStart(u8 a) {
    sou_bgm_call_buffer_u8 = a;
    sou_bgm_call_buffer = 2;
}

void Na_BgmStop(u16 a) {
    sou_bgm_call_buffer_u16 = a;
    sou_bgm_call_buffer = 3;
}

void Na_SysTrgStart(u16 id) {
    u8 v = FALSE;
    u8 pan = 0x3f;
    u8 reverb = 0;
    u8 unused = 0;
    f32 volume = 1.f;
    f32 optVolume = 1.f;
    f32 freqScale = 1.f;
    f32 distance = 0.f;
    if (id == 0x54 && sou_last_sys_trg_num == 0x54) {
        if (sou_kokoro_toguru == 0) {
            sou_kokoro_toguru = 1;
            if (sou_game_frame_counter - sou_last_kokoro_counter == 1) {
                return;
            }
        } else {
            sou_kokoro_toguru = 0;
        }
    }

    sou_last_kokoro_counter = sou_game_frame_counter;
    sou_kokoro_toguru = 0;
    sou_last_sys_trg_num = id;
    switch (id) {
        case 0x424: {
            if (sou_scene_mode != 1) {
                id = 0x16e;
            }
        } break;
        case 0xd: {
            sou_SE_SENTAKU_KETTEI_timer = 1;
        } break;
        case 0x8005: {
            if (sou_SE_SENTAKU_KETTEI_timer != 0) {
                v = TRUE;
            }
        } break;
    }

    if (!v) {
        Sou_TrgStart(id, volume, optVolume, freqScale, pan, reverb, distance);
    }
}

void Sou_WalkSe(u16 id, u16 angle, f32 distance, u8 reverb, f32 optVolume) {
    u8 pan = 0x3f;
    u8 unused = 0;
    u16 v = 0;
    f32 freqScale = 1.f;
    f32 volume = 1.;

    if (id == 0 || distance > SOU_ONGEN_AREA1) {
        // needed to match, probably stripped assert;
        (void)0;
        return;
    }

    pan = angle2pan(angle, distance);
    volume = distance2vol(distance);
    v = Nap_GetRandom();
    v >>= 0xe;
    if (sou_player_dash == 3) {
        id = id + 40;
    }
    if ((sou_walk_flag & 1) == 1) {
        if (v == 3 && sou_last_walk_l == 0 && sou_last_walk_r == 0) {
            id = id + 0x1e;
            sou_last_walk_l = 1;
        } else {
            id = id + 0xa;
            sou_last_walk_l = 0;
        }
    } else if (v == 3 && sou_last_walk_l == 0 && sou_last_walk_r == 0) {
        id = id + 0x14;
        sou_last_walk_r = 1;
    } else {
        sou_last_walk_r = 0;
    }
    sou_walk_flag++;
    Sou_TrgStart(id, volume, optVolume, freqScale, pan, reverb, distance);
}

void Na_PlyWalkSe(u16 id, u16 angle, f32 distance) {
    u8 reverb = 0;
    f32 optVolume = 1.f;
    if (sou_scene_mode) {
        switch (sou_player_dash) {
            case 1: {
                optVolume = 0.6f;
            } break;
            case 2: {
                optVolume = 0.8f;
            } break;
            case 3: {
                optVolume = 1.0f;
            } break;
        }

        Sou_WalkSe(id, angle, distance, reverb, optVolume);
    }
}

void Na_PlyWalkSeRoom(u8 a, u16 angle, f32 distance) {
    u16 id = 0;
    u8 reverb = 0;
    f32 optVolume = 1.f;
    if (sou_scene_mode) {
        switch (sou_scene_mode) {
            case 0xf: {
                reverb = 0x32;
            } break;
            case 0x10: {
                reverb = 0x32;
            } break;
            default: {
                reverb = 5;
            } break;
        }
        if (a == 0xff) {
            id = 0x4204;
        } else {
            id = SE_FLOOR_DATA[a] + 0x42e6;
        }
        switch (sou_player_dash) {
            case 1: {
                optVolume = 0.54f;
            } break;
            case 2: {
                optVolume = 0.71999997f;
            } break;
            case 3: {
                optVolume = 0.9f;
            } break;
        }
        Sou_WalkSe(id, angle, distance, reverb, optVolume);
    }
}

void Na_NpcWalkSe(u16 id, u16 angle, f32 distance) {
    u8 reverb = 0;
    f32 optVolume = 0.68f;
    if (sou_scene_mode == 0 || sou_scene_mode == 0xc) {
        (void)0;
        return;
    }
    Sou_WalkSe(id, angle, distance, reverb, optVolume);
}

void Na_NpcWalkSeRoom(u8 index, u16 angle, f32 distance) {
    u16 id = 0;
    u8 reverb = 0;
    f32 optVolume = 0.612f;
    if (sou_scene_mode == 0 || sou_scene_mode == 0xe) {
        (void)0;
        return;
    }
    switch (sou_scene_mode) {
        case 0xf: {
            reverb = 0x32;
        } break;
        case 0x10: {
            reverb = 0x32;
        } break;
        default: {
            reverb = 5;
        } break;
    }
    id = SE_FLOOR_DATA[index] + 0x42e6;
    Sou_WalkSe(id, angle, distance, reverb, optVolume);
}

extern void Na_PlayerStatusLevel(u8 playerDash, f32 playerSpeed) {
    sou_player_dash = playerDash;
    sou_player_speed = playerSpeed;
}

u8 Sou_TanboinHenkan(u8 a, u8 b) {
    switch (a) {
        case 0x5d:
            return 0x01;
        case 0x65:
            return 0x14;
        case 0x71:
            return 0x29;
        case 0x61:
            return 0x0a;
        case 0x6b:
            return 0x1d;
        case 0x6a:
            return 0x1b;
        case 0x53:
            return 0x32;
        case 0x54:
            return 0x33;
        case 0x55:
            return 0x26;
        case 0x56:
            return 0x27;
        case 0x57:
            return 0x34;
        case 0x58:
            return 0x35;
        case 0x59:
            return 0x36;
        case 0x5a:
            return 0x37;
        case 0x5b:
            return 0x10;
        case 0x5c:
            return 0x38;
        case 0x5e:
            return 7;
        case 0x5f: {
            switch (b) {
                case 0x65:
                case 0x61:
                    return 0x23;
                default:
                    return 0x18;
            }
        }
        case 0x60:
            return 0x09;
        case 0x62:
            return 0x11;
        case 0x63:
            return 0x12;
        case 0x64:
            return 0x00;
        case 0x66:
            return 0x17;
        case 0x67:
            return 0x18;
        case 0x68:
            return 0x19;
        case 0x69:
            return 0x1a;
        case 0x6c:
            return 0x21;
        case 0x6d:
            return 0x18;
        case 0x6e:
            return 0x22;
        case 0x6f:
            return 0x23;
        case 0x70:
            return 0x26;
        case 0x72:
            return 0x2d;
        case 0x73:
            return 0x2e;
        case 0x74:
            return 0x31;
        case 0x75:
            return 0x15;
        case 0x76:
            return 0x30;
    }
    return a;
}

u8 Sou_ChouboinHenkan(u8 a, u8 b) {
    switch (a) {
        case 0x5d:
            return 0x02;
        case 0x65:
            return 0x15;
        case 0x71:
            return 0x2a;
        case 0x61:
            return 0x0e;
        case 0x6b:
            return 0x1e;
        case 0x6a:
            return 0x1b;
        case 0x53:
            return 0x32;
        case 0x54:
            return 0x33;
        case 0x55:
            return 0x26;
        case 0x56:
            return 0x27;
        case 0x57:
            return 0x34;
        case 0x58:
            return 0x35;
        case 0x59:
            return 0x36;
        case 0x5a:
            return 0x37;
        case 0x5b:
            return 0x10;
        case 0x5c:
            return 0x38;
        case 0x5e:
            return 7;
        case 0x5f: {
            switch (b) {
                case 0x65:
                case 0x61:
                    return 0x23;
                default:
                    return 0x18;
            }
        }
        case 0x60:
            return 0x09;
        case 0x62:
            return 0x11;
        case 0x63:
            return 0x12;
        case 0x64:
            return 0x00;
        case 0x66:
            return 0x17;
        case 0x67:
            return 0x18;
        case 0x68:
            return 0x19;
        case 0x69:
            return 0x1a;
        case 0x6c:
            return 0x21;
        case 0x6d:
            return 0x18;
        case 0x6e:
            return 0x22;
        case 0x6f:
            return 0x23;
        case 0x70:
            return 0x26;
        case 0x72:
            return 0x2d;
        case 0x73:
            return 0x2e;
        case 0x74:
            return 0x31;
        case 0x75:
            return 0x15;
        case 0x76:
            return 0x30;
    }
    return a;
}

u8 Sou_ConnectCheck(u8 a, u8 b, u8 c) {
    switch (a) {
        case 0x5d: {
            switch (b) {
                case 0x65:
                    a = 0xf;
                    break;
                case 0x68:
                    a = 0x2;
                    break;
                case 0x6e:
                    a = 0x16;
                    break;
                case 0x6a:
                    a = 0x39;
                    break;
                case 0x6f:
                    a = 0x3a;
                    break;
            }
        } break;
        case 0x61: {
            switch (b) {
                case 0x5d:
                    a = 0x15;
                    break;
                case 0x6e:
                    a = 0xd;
                    break;
            }
        } break;
        case 0x5e: {
            switch (b) {
                case 0x61:
                    a = 0x3b;
                    break;
                case 0x75:
                    a = 0x3c;
                    break;
            }
        } break;
        case 0x5f: {
            switch (b) {
                case 100:
                    a = 8;
                    break;
            }
        } break;
        case 0x60: {
            switch (b) {
                case 0x6b:
                    a = 0x3d;
                    break;
            }
        } break;
        case 0x62: {
            switch (b) {
                case 0x5d:
                    a = 0x35;
                    break;
                case 0x6b:
                    a = 0x34;
                    break;
            }
        } break;
        case 0x63: {
            switch (b) {
                case 0x61:
                    a = 0x17;
                    break;
                case 0x6b:
                    a = 0x3e;
                    break;
            }
        } break;
        case 0x64: {
            switch (b) {
                case 0x5d:
                    a = 0x3f;
                    break;
                case 0x61:
                    a = 0x40;
                    break;
                case 0x65:
                    a = 0x41;
                    break;
                case 0x6b:
                    a = 0x42;
                    break;
            }
        } break;
        case 0x65: {
            switch (b) {
                case 0x6e:
                    a = 0xc;
                    break;
                case 0x81:
                    a = 5;
                    break;
                case 0x62:
                    a = 0x43;
                    break;
                case 0x6a:
                    a = 0x44;
                    break;
                case 0x6f:
                    a = 0x45;
                    break;
                case 0x70:
                    a = 0x46;
                    break;
            }
        } break;
        case 0x67: {
            switch (b) {
                case 0x6f:
                    a = 0x31;
                    break;
            }
        } break;
        case 0x69: {
            switch (b) {
                case 0x61:
                    a = 0x47;
                    break;
                case 0x75:
                    a = 0x48;
                    break;
            }
        } break;
        case 0x6a: {
            switch (b) {
                case 0x5d:
                    a = 0x38;
                    break;
                case 99:
                    a = 0x1c;
                    break;
                case 0x6b:
                    a = 0x49;
                    break;
            }
        } break;
        case 0x6b: {
            switch (b) {
                case 0x6b:
                    a = 0x2a;
                    break;
                case 0x73:
                    a = 6;
                    break;
                case 0x75:
                    a = 0x1f;
                    break;
                case 0x71:
                    a = 0x20;
                    break;
                case 0x6e:
                    a = 0x2c;
                    break;
                case 0x62:
                    a = 0x4a;
                    break;
                case 100:
                    a = 0x4b;
                    break;
                case 0x67:
                    a = 0x4c;
                    break;
                case 0x6a:
                    a = 0x4d;
                    break;
            }
        } break;
        case 0x6e: {
            switch (b) {
                case 0x61:
                    a = 0xe;
                    break;
            }
        } break;
        case 0x6f: {
            switch (b) {
                case 0x61:
                    a = 0x37;
                    break;
                case 100:
                    a = 0x24;
                    break;
                case 0x65:
                    a = 0x36;
                    break;
                case 0x71:
                    a = 0x25;
                    break;
                case 0x6b:
                    a = 0x4f;
                    break;
            }
        } break;
        case 0x70: {
            switch (b) {
                case 100:
                    a = 0x28;
                    break;
                case 0x6b:
                    a = 0x50;
                    break;
            }
        } break;
        case 0x71: {
            switch (b) {
                case 0x6c:
                    a = 0x51;
                    break;
            }
        } break;
        case 0x73: {
            switch (b) {
                case 0x61:
                    a = 0x52;
                    break;
                case 0x6b:
                    a = 0x33;
                    break;
            }
        } break;
        case 0x75: {
            switch (b) {
                case 0x6b:
                    switch (c) {
                        case 0x71:
                            a = 0x77;
                            break;
                    }
            }
        } break;
        case 0x76: {
            switch (b) {
                case 0x61:
                    a = 0x32;
            }
            break;
        }
    }
    return a;
}

u8 Sou_BoinShiinCheck(u8 a) {
    switch (a) {
        case 0x5d:
        case 0x61:
        case 0x65:
        case 0x6a:
        case 0x6b:
        case 0x71:
            return 0;
        case 0x5e:
        case 0x5f:
        case 0x60:
        case 0x62:
        case 0x63:
        case 0x64:
        case 0x66:
        case 0x67:
        case 0x68:
        case 0x69:
        case 0x6c:
        case 0x6d:
        case 0x6e:
        case 0x6f:
        case 0x70:
        case 0x72:
        case 0x73:
        case 0x74:
        case 0x75:
        case 0x76:
            return 1;
    }
    return 2;
}

void Na_VoiceSe(u8 a, u8 b, u8 c, s16 voice, u8 scale, u8 f) {
    sou_Na_VoiceSeFlag = 1;
    u8 i = 0;
    u8 r28;

    switch (f) {
        case 0: {
            sou_num_org = a;
            sou_num2_org = b;
            sou_num3_org = c;
            r28 = 0;
            if (a == 0x85 && b == 0xff && c == 0xff) {
                return;
            }
            if (a == 0x61 && b > 0x77 && Sou_BoinShiinCheck(sou_last_num) == 0 &&
                Sou_BoinShiinCheck(sou_last_num2) == 1) {
                a = b;
                r28 = 4;
            }
            if (b == 0x61 && c > 0x77 && Sou_BoinShiinCheck(sou_last_num2) == 0 && Sou_BoinShiinCheck(a) == 1) {
                b = 0;
                r28 = 4;
            }

            if (r28 != 4) {
                a = Sou_ConnectCheck(a, b, c);
                if (a == sou_num_org) {
                    r28 = 1;
                } else {
                    r28 = 2;
                }

                switch (b) {
                    case 0xff:
                    case 0x80:
                    case 0x81:
                    case 0x82:
                    case 0x83:
                    case 0x84:
                    case 0x85:
                    case 0x86: {
                        r28 = 3;
                        switch (sou_last_num2) {
                            case 0xff:
                            case 0x80:
                            case 0x81:
                            case 0x82:
                            case 0x83:
                            case 0x84:
                            case 0x85:
                            case 0x86: {
                                r28 = 1;
                            } break;
                        }
                    }
                }
            }

            switch (r28) {
                case 1:
                case 4: {
                    if (Sou_BoinShiinCheck(a) == 0 && Sou_BoinShiinCheck(b) == 1 && c == 0x61) {
                        a = Sou_ChouboinHenkan(a, b);
                    } else {
                        a = Sou_TanboinHenkan(a, b);
                    }
                    sou_num2_request = b;
                    sou_num2_animal_id = voice;
                    sou_num2_scale = scale;
                } break;
                case 3: {
                    if (a > 0x77) {
                        break;
                    }
                    a = sou_last_num2;
                    b = sou_num_org;
                    c = sou_num2_org;
                    a = Sou_ConnectCheck(a, b, c);
                    if (a < 0x53 || a > 0x76) {
                        break;
                    }
                    a = Sou_TanboinHenkan(a, b);
                } break;
                case 2:
                case 0:
                default:
                    break;
            }
            break;
        } break;
        case 2: {
            if (sou_voice_mode == 1) {
                return;
            }
            switch (a) {
                case 0xff:
                    return;
            }
            if (a == 0x61 && sou_num3_org > 0x77 && Sou_BoinShiinCheck(sou_last_num2) == 0 &&
                Sou_BoinShiinCheck(sou_num_org) == 1) {
                a = 0;
            } else {
                a = Sou_TanboinHenkan(a, sou_num3_org);
            }
        } break;
    }
    switch (f) {
        case 0: {
            if (sou_num_org == sou_last_num2 && sou_num_org == sou_last_num) {
                i = 1;
            }
        } break;
        case 2: {
            if (sou_num_org == sou_num_org && sou_num_org == sou_last_num2) {
                i = 1;
            }
        } break;
    }
    sou_last_num = sou_num_org;
    sou_last_num2 = sou_num2_org;
    u8 unused = 0;
    u8 r22 = 0;
    u8 r27 = 0;
    u8 r25 = 0;
    u8 r29 = 0;
    f32 f31 = 0.f;
    f32 f30 = 0.f;
    u8 r23;
    if (voice > 0x12b) {
        return;
    }
    if ((sou_voice_mode == 0 && Nap_ReadSubPort(4, 0, 1) != sou_now_voice_seq)) {
        return;
    }
    if (sou_scene_mode == 0) {
        return;
    }
    if (a == 0x80) {
        if (voice == 0xfa) {
            return;
        }
        switch (sou_voice_mode) {
            case 0:
                Na_MelodyVoice(voice);
                break;
            case 1:
                Na_SysTrgStart(0x106d);
                break;
            case 2:
            default:
                break;
        }
        return;
    }
    r29 = a;
    if (sou_voice_se_toguru == 0) {
        r22 = 0;
        sou_voice_se_toguru = 1;
    } else {
        r22 = 1;
        sou_voice_se_toguru = 0;
    }
    switch (sou_now_spec) {
        case 2: {
            sou_voice_se[0]._08 = 0.65f;
            sou_voice_se[1]._08 = 0.65f;
            sou_voice_se[0]._14 = 1.f;
            sou_voice_se[1]._14 = 1.f;
        } break;
        case 3: {
            sou_voice_se[0]._08 = 0.65f;
            sou_voice_se[1]._08 = 0.65f;
            sou_voice_se[0]._14 = 1.f;
            sou_voice_se[1]._14 = 1.f;
        } break;
        case 4: {
            sou_voice_se[0]._08 = 0.65f;
            sou_voice_se[1]._08 = 0.65f;
            sou_voice_se[0]._14 = 1.f;
            sou_voice_se[1]._14 = 1.f;
        } break;
        case 5: {
            sou_voice_se[0]._08 = 0.9f;
            sou_voice_se[1]._08 = 0.9f;
            sou_voice_se[0]._14 = 1.f;
            sou_voice_se[1]._14 = 1.f;
        } break;
        case 6: {
            sou_voice_se[0]._08 = 0.9f;
            sou_voice_se[1]._08 = 0.9f;
            sou_voice_se[0]._14 = 1.f;
            sou_voice_se[1]._14 = 1.f;
        } break;
        case 7: {
            sou_voice_se[0]._08 = 0.9f;
            sou_voice_se[1]._08 = 0.9f;
            sou_voice_se[0]._14 = 1.3f;
            sou_voice_se[1]._14 = 1.3f;
        } break;
        case 8: {
            sou_voice_se[0]._08 = 0.9f;
            sou_voice_se[1]._08 = 0.9f;
            sou_voice_se[0]._14 = 0.75f;
            sou_voice_se[1]._14 = 0.75f;
        } break;
        case 9: {
            sou_voice_se[0]._08 = 0.7f;
            sou_voice_se[1]._08 = 0.7f;
            sou_voice_se[0]._14 = 0.65f;
            sou_voice_se[1]._14 = 0.65f;
        } break;
    }
    switch (sou_voice_mode) {
        case 0: {
            switch (sou_now_spec) {
                case 5:
                case 6: {
                    switch (a) {
                        case 0x81:
                        case 0x84:
                        case 0x85:
                        case 0x86:
                            Na_SysTrgStart(0x106d);
                            a = 0;
                            break;
                    }
                } break;
                default: {
                    switch (a) {
                        case 0x86: {
                            Na_SysTrgStart(0x106d);
                            a = 0;
                            sou_nobasu_count = 0;
                        } break;
                        case 0x81:
                        case 0x84:
                        case 0x85: {
                            a = 0;
                            sou_nobasu_count = 0;
                        } break;
                        case 0x82: {
                            a = 0;
                            sou_nobasu_count = 0;
                            switch (sou_now_voice_seq) {
                                case 1: {
                                    f31 = 1.24f;
                                } break;
                                case 2: {
                                    f31 = 1.3f;
                                } break;
                                case 3: {
                                    f31 = 1.13f;
                                } break;
                            }
                            sou_voice_se[0]._14 = sou_voice_se[0]._14 * f31;
                            sou_voice_se[1]._14 = sou_voice_se[0]._14;
                        } break;
                        case 0x83: {
                            a = 0;
                            sou_nobasu_count = 0;
                            sou_voice_se[0]._08 = sou_voice_se[0]._08 * 1.15f;
                            sou_voice_se[1]._08 = sou_voice_se[0]._08;
                        } break;
                        default: {
                            sou_nobasu_count = 0;
                            sou_now_boin = SHIIN2BOIN[a];
                        } break;
                    }
                }

                break;
            }
            if (sou_now_spec == 5 || sou_now_spec == 6 || r29 > 0x77) {
                i = 0;
            }
            if (i == 1) {
                r27 = Nap_GetRandom();
                a = r27 >> 2;
            }
            sou_last_voice = r29;
            if (r29 <= 0x77 && sou_now_spec != 5) {
                if (sou_now_spec != 6) {
                    switch (sou_message_status) {
                        case 1: {
                            if (sou_voice_effect_counter == 0) {
                                r27 = Nap_GetRandom();
                                r25 = r27 >> 6;
                                sou_voice_effect_counter = r25 + 0xa;
                            } else {
                                sou_voice_effect_counter--;
                            }
                            switch (sou_voice_effect_counter) {
                                case 0:
                                case 1:
                                case 2: {
                                    sou_voice_se[0]._18 = 1.25f;
                                    sou_voice_se[1]._18 = 1.25f;
                                    sou_voice_se[0]._0C = 1.25f;
                                    sou_voice_se[1]._0C = 1.25f;
                                } break;
                                case 3:
                                case 4: {
                                    sou_voice_se[0]._18 = 1.2f;
                                    sou_voice_se[1]._18 = 1.2f;
                                    sou_voice_se[0]._0C = 1.2f;
                                    sou_voice_se[1]._0C = 1.2f;
                                } break;
                                case 9:
                                case 10: {
                                    sou_voice_se[0]._18 = 1.25f;
                                    sou_voice_se[1]._18 = 1.25f;
                                    sou_voice_se[0]._0C = 1.25f;
                                    sou_voice_se[1]._0C = 1.25f;
                                } break;
                                default: {
                                    sou_voice_se[0]._18 = 0.9f;
                                    sou_voice_se[1]._18 = 0.9f;
                                    sou_voice_se[0]._0C = 1.05f;
                                    sou_voice_se[1]._0C = 1.05f;
                                } break;
                            }
                        } break;
                        case 2:
                        case 4:
                        case 5: {
                            if (sou_voice_effect_counter == 0) {
                                r27 = Nap_GetRandom();
                                r25 = r27 >> 6;
                                sou_voice_effect = r25 + 0xe;
                                sou_voice_effect_counter = 1;
                            } else if (sou_voice_effect_counter == sou_voice_effect) {
                                sou_voice_effect_counter = 0;
                                if (sou_voice_sad_toguru == 0) {
                                    sou_voice_sad_toguru = 1;
                                } else {
                                    sou_voice_sad_toguru = 0;
                                }
                            } else {
                                sou_voice_effect_counter++;
                            }
                            if (sou_voice_sad_toguru == 0) {
                                f31 = 1.f - sou_voice_effect_counter * 0.022f;
                            } else {
                                f31 = 1.1f - sou_voice_effect_counter * 0.022f;
                            }
                            sou_voice_se[0]._18 = f31;
                            sou_voice_se[1]._18 = f31;
                            if (sou_voice_sad_toguru == 0) {
                                f31 = 1.f - sou_voice_effect_counter * 0.025f;
                            } else {
                                f31 = 1.1f - sou_voice_effect_counter * 0.025f;
                            }
                            sou_voice_se[0]._0C = f31;
                            sou_voice_se[1]._0C = f31;
                        } break;
                        case 3: {
                            if (sou_voice_effect_counter == 0) { // c28
                                r27 = Nap_GetRandom();
                                r25 = r27 >> 6;
                                sou_voice_effect_counter = r25 + 0xa;
                            } else {
                                sou_voice_effect_counter--;
                            }
                            switch (sou_voice_effect_counter) {
                                case 0:
                                case 1: {
                                    sou_voice_se[0]._18 = 1.05f;
                                    sou_voice_se[1]._18 = 1.05f;
                                    sou_voice_se[0]._0C = 1.05f;
                                    sou_voice_se[1]._0C = 1.05f;
                                } break;
                                case 2: {
                                    sou_voice_se[0]._18 = 0.9f;
                                    sou_voice_se[1]._18 = 0.9f;
                                    sou_voice_se[0]._0C = 1.15f;
                                    sou_voice_se[1]._0C = 1.15f;
                                } break;
                                default: {
                                    sou_voice_se[0]._18 = 1.15f;
                                    sou_voice_se[1]._18 = 1.15f;
                                    sou_voice_se[0]._0C = 1.05f;
                                    sou_voice_se[1]._0C = 1.05f;
                                } break;
                            } // d48
                        } break;
                        default: {
                            sou_voice_se[0]._18 = 1.f;
                            sou_voice_se[1]._18 = 1.f;
                            sou_voice_se[0]._0C = 1.f;
                            sou_voice_se[1]._0C = 1.f;
                        } break;
                    }
                }
            }

            if (r29 != 0x85 && r29 != 0x81 && r29 != 0x84) {
                if (scale != 0x20) {
                    if (scale > 0x20) {
                        scale = scale - 0x20;
                        f31 = scale;
                        f31 = f31 * 0.15f;
                        f30 = sou_voice_se[0]._08 + f31;
                        f30 = 4.f;
                        sou_voice_se[0]._08 = f30;
                        sou_voice_se[1]._08 = f30;
                    } else {
                        scale = 0x1f - scale;
                        f31 = scale;
                        f31 = f31 * 0.02f;
                        f30 = sou_voice_se[0]._08 - f31;
                        f30 = 0.4f;
                        sou_voice_se[0]._08 = f30;
                        sou_voice_se[1]._08 = f30;
                    }
                }
                if (a != 0 && a <= 0x77) {
                    Sou_VoiceStart((u8)r22, a);
                }
            }
        } break;
        case 1: {
            if (r29 != 0x81 && r29 != 0x84) {
                Na_SysTrgStart(0x106d);
            }
        } break;
        case 2:
            break;
    }
}

void Na_MessageStatus(u8 messageStatus) {
    sou_message_status = messageStatus;
    sou_voice_effect = 0;
    sou_voice_effect_counter = 0;
}

void Na_MessageSpeed(u8 messageSpeed) {
    sou_message_speed = messageSpeed;
}

u8 Na_MessageSpeedGet() {
    return sou_message_speed;
}

void Na_OngenPos(u32 id, u8 index, u16 angle, f32 distance) {
    u8 pan = 0;
    u8 i = 0;
    u8 j = 0;
    u8 found = 0;
    u8 foundIndex = 0;
    u8 found2 = 0;

    if (index == 0x44) {
        u8 unused = Na_RoomIncectPos(id, index, angle, distance);
        return;
    }

    if (sou_sub_game_flag != 1 && sou_scene_mode != 0) {

        if ((sou_scene_mode == 8 || sou_scene_mode == 9) && (index == 0xb || index == 0x16)) {
            return;
        }
        if (sou_ongenpos_kill_countdown == 1) {
            return;
        }

        //! @BUG: should be ARRAY_COUNT(sou_lev_ongen_data), reading unknown data
        if (index == 0xb) {
            for (i = 0; i < ARRAY_COUNT(sou_ongen_entry); i++) {
                if (sou_lev_ongen_data[i]._08 == 0xc) {
                    for (j = 0; j < ARRAY_COUNT(sou_ongen_entry); j++) {
                        if (sou_lev_ongen_data[j]._08 == 0xb && sou_lev_ongen_data[j].distance < distance) {
                            return;
                        }
                    }
                }
            }
        }

        if (index == 0 || distance > SOU_ONGEN_AREA1) {
            (void)0;
            return;
        }
        pan = angle2pan(angle, distance);
        for (i = 0; i < ARRAY_COUNT(sou_ongen_entry); i++) {
            if (id == sou_ongen_entry[i]._00) {
                j = i;
                i = ARRAY_COUNT(sou_ongen_entry);
                found = 1;
            }
        }
        if (found == 0) {
            for (i = 0; i < ARRAY_COUNT(sou_ongen_entry); i++) {
                if (sou_ongen_entry[i]._00 == 0) {
                    sou_ongen_entry[i]._00 = id;
                    sou_ongen_entry[i]._06 = index;
                    sou_ongen_entry[i].pan = pan;
                    sou_ongen_entry[i].distance = distance;
                    sou_ongen_entry[i]._09 = 1;
                    sou_ongen_entry[i]._0A = 0;
                    foundIndex = i;
                    i = ARRAY_COUNT(sou_ongen_entry);
                }
            }
            for (i = 0; i < ARRAY_COUNT(sou_ongen_entry); i++) {
                if (sou_ongen_entry[i]._00 != 0) {
                    sou_ongen_entry[i]._04++;
                }
            }
            for (i = 0; i < ARRAY_COUNT(sou_lev_ongen_data); i++) {
                if (sou_lev_ongen_data[i]._08 == 0) {
                    found2 = 1;
                    j = i;
                    i = 4;
                }
            }
            if (found2 == 1) {
                for (i = 0; i < ARRAY_COUNT(sou_lev_ongen_data); i++) {
                    if (sou_lev_ongen_data[i]._08 != 0) {
                        sou_lev_ongen_data[i]._09++;
                    }
                }
                sou_lev_ongen_data[j]._09 = 1;
                sou_lev_ongen_data[j]._04 = sou_ongen_entry[foundIndex]._00;
                sou_lev_ongen_data[j]._08 = sou_ongen_entry[foundIndex]._06;
                sou_lev_ongen_data[j].distance = sou_ongen_entry[foundIndex].distance;
                sou_lev_se[j].pan = sou_ongen_entry[foundIndex].pan;
                sou_lev_ongen_data[j]._00 = 1;
                sou_lev_ongen_data[j]._01 = 0;
                return;
            } else {
                j = 0;
                for (i = 0; i < ARRAY_COUNT(sou_lev_ongen_data); i++) {
                    if (sou_lev_ongen_data[i]._09 > j) {
                        j = sou_lev_ongen_data[i]._09;
                        found2 = i;
                    }
                }
                Sou_LevStop((u8)found2, sou_lev_ongen_data[found2]._08);
                for (i = 0; i < ARRAY_COUNT(sou_lev_ongen_data); i++) {
                    if (sou_lev_ongen_data[i]._09 != 0) {
                        sou_lev_ongen_data[i]._09++;
                    }
                }
                sou_lev_ongen_data[found2]._09 = 1;
                sou_lev_ongen_data[found2]._04 = sou_ongen_entry[foundIndex]._00;
                sou_lev_ongen_data[found2]._08 = sou_ongen_entry[foundIndex]._06;
                sou_lev_ongen_data[found2].distance = sou_ongen_entry[foundIndex].distance;
                sou_lev_se[found2].pan = sou_ongen_entry[foundIndex].pan;
                sou_lev_ongen_data[found2]._00 = 1;
                sou_lev_ongen_data[found2]._01 = 0;
                sou_lev_ongen_data[found2].distance2 = 9999.f;
                sou_lev_ongen_data[found2]._03 = 0;
                sou_lev_ongen_data[found2]._02 = 1;
            }
        } else {
            sou_ongen_entry[j]._06 = index;
            sou_ongen_entry[j].pan = pan;
            sou_ongen_entry[j].distance = distance;
            sou_ongen_entry[j]._09++;
        }
    }
}

// the name `num` comes from Na_OngenTrgStartSpeed
void Sou_PosTrgStart(u16 num, u16 angle, f32 distance, u8 reverb, f32 optVolume) {
    u8 unused = 0;
    u8 pan = 0x3f;
    u8 r26 = 0;
    u16 rand = 0;
    u16 r29 = 0;
    u16 r30 = 0;
    f32 volume = 1.f;
    f32 freqScale = 1.f;
    switch (num) {
        case 0x6e:
        case 0x6f:
        case 0x70:
        case 0x71: {
            if (num == 0 || distance > 6400.f) {
                return;
            }
            volume = distance2vol4KITEKI(distance);
        } break;
        default: {
            if (num == 0 || distance > SOU_ONGEN_AREA1) {
                return;
            }
            volume = distance2vol(distance);
        } break;
    }
    pan = angle2pan(angle, distance);
    if (num == 0x19) {
        r26 = sou_metranome_counter & 3;
        if (r26 == 0) {
            num++;
        }
        sou_metranome_counter++;
    }
    if (num == 0x167) {
        rand = Nap_GetRandom();
        r30 = rand & 1;
        if (num == sou_last_uchiwa) {
            num = num + r30 + 1;
            if (num == 0x16a) {
                num = 0x167;
            }
        } else {
            num = num + r30;
        }
        sou_last_uchiwa = num;
    }
    if (num == 0x122) {
        rand = Nap_GetRandom();
        r30 = rand & 3;
        switch (sou_last_perio) {
            case 0x122: {
                r29 = r30 + 1;
            } break;
            case 0x123:
            case 0x124:
            case 0x125: {
                if (r30 > sou_last_perio - 0x123) {
                    r29 = r30 + 1;
                } else {
                    r29 = r30;
                }
            } break;
            case 0x126: {
                r29 = r30;
            } break;
        }
        num = num + r29;
        sou_last_perio = num;
    }
    Sou_TrgStart(num, volume, optVolume, freqScale, pan, reverb, distance);
}

extern void Na_OngenTrgStartSpeed(u16 num, u16 angle, f32 distance, f32 speed) {
    u8 reverb = 0;
    u8 r29 = 0;
    f32 opt_volume = 1.f;
    OSAttention("BANDO_DEBUG:\n");
    OSAttention("BANDO_DEBUG: Na_OngenTrgStartSpeed called num=%04x \n", num);
    OSAttention("BANDO_DEBUG: angle=%d distance=%f speed=%f\n", angle, distance, speed);
    if (sou_scene_mode != 0) {
        opt_volume = 0.5f + 0.07f * speed;
        if (opt_volume > 0.9f) {
            opt_volume = 0.9f;
        }
        OSAttention("BANDO_DEBUG: opt_volume=%f\n", opt_volume);
        if (r29 == 0) {
            Sou_PosTrgStart(num, angle, distance, reverb, opt_volume);
        }
    }
}

extern void Na_OngenTrgStart(u16 a, u16 angle, f32 distance) {
    u8 r29 = 0;
    u8 r31 = 0;
    f32 f31 = 1.f;
    if (sou_scene_mode == 0) {
        return;
    }
    if (a == 0x12d && sou_now_bgm_num != 0) {
        return;
    }
    switch (a) {
        case 0x15c: {
            sou_SE_ami_hit_water_timer = 1;
        } break;
        case 0x5c: {
            if (sou_SE_ami_hit_water_timer != 0) {
                r31 = 1;
            }
        } break;
        case 0x43b: {
            if (distance > 375.f) {
                r31 = 1;
            }
            if (sou_now_bgm_num == 0x42 || sou_now_bgm_num == 0x4e || sou_scene_mode == 0xc) {
                r31 = 1;
            }
        } break;
        case 0x511:
        case 0x501:
        case 0x509:
        case 0x505:
        case 0x50d:
        case 0x521:
        case 0x519:
        case 0x515:
        case 0x51d:
        case 0x529:
        case 0x525: {
            if (sou_scene_mode == 0xe) {
                r31 = 1;
            }
        } break;
    }

    if (r31 == 0) {
        Sou_PosTrgStart(a, angle, distance, r29, f31);
    }
}

extern void Na_SetOutMode(u8 outMode) {
    sou_out_mode = outMode;
    switch (outMode) {
        case 0: {
            NA_COMMAND_AUDIO_SET_SOUND_MODE(0);
        } break;
        case 2: {
            NA_COMMAND_AUDIO_SET_SOUND_MODE(1);
        } break;
        case 1: {
            NA_COMMAND_AUDIO_SET_SOUND_MODE(3);
        } break;
    }
}

extern void Na_SetVoiceMode(u8 a) {
    sou_voice_mode = a;
}

extern void Na_FloorTrgStart(u8 index, u16 angle, f32 distance) {
    u16 r31 = 0;
    u8 r30 = 0;
    f32 f31 = 1.f;
    if (sou_scene_mode != 0) {
        r31 = SE_FLOOR_DATA[index];
        Sou_PosTrgStart(r31, angle, distance, r30, f31);
    }
}

extern void Na_SysLevStart(u8 a) {
    u8 i = 0;
    u8 j = 0;
    u8 maxVal = 0;
    u8 foundIndex = 0;
    for (i = 0; i < ARRAY_COUNT(sou_sys_lev); i++) {
        if (sou_sys_lev[i]._0 == 0) {
            for (j = 0; j < ARRAY_COUNT(sou_sys_lev); j++) {
                sou_sys_lev[i]._1++;
            }
            foundIndex = i;
            goto offset_jmp;
        }
    }
    maxVal = 0;
    for (j = 0; j < ARRAY_COUNT(sou_sys_lev); j++) {
        if (sou_sys_lev[j]._1 > maxVal) {
            maxVal = sou_sys_lev[j]._1;
            foundIndex = j;
        }
    }
    for (j = 0; j < ARRAY_COUNT(sou_sys_lev); j++) {
        //! BUG: `i` will be ARRAY_COUNT(sou_sys_lev) if we get to this point,
        // and we will be incrementing out of bounds
        sou_sys_lev[i]._1++;
    }

offset_jmp:
    sou_sys_lev[foundIndex]._0 = a;
    sou_lev_se[foundIndex + 4].volumeScale = 1.f;
    sou_lev_se[foundIndex + 4]._0C = 1.f;
    if (a == 0x8d && sou_kiteki_counter == 0) {
        sou_kiteki_counter = 1;
    }
    if (sou_scene_mode == 2 || sou_scene_mode == 0xe || sou_scene_mode == 0xf || sou_scene_mode == 0x10) {
        switch (a) {
            case 7:
            case 8:
            case 9: {
                sou_lev_se[foundIndex + 4].volumeScale = 0.4f;
            } break;
        }
    }
    Sou_LevStart(foundIndex + 4, a);
}

extern void Na_SysLevStop(u8 a) {
    u8 i = 0;
    u8 index = 0;
    if (a == 0x8d) {
        sou_kiteki_counter = 0;
    }
    for (i = 0; i < ARRAY_COUNT(sou_sys_lev); i++) {
        if (a == sou_sys_lev[i]._0) {
            sou_sys_lev[i]._0 = 0;
            sou_sys_lev[i]._1 = 0;
            index = i;
            i = ARRAY_COUNT(sou_sys_lev);
        }
    }
    Sou_LevStop(index + 4, a);
}

extern void Na_Pause(u8 pauseFlag) {
    if (pauseFlag == sou_pause_flag) {
        return;
    }

    switch (pauseFlag) {
        case 0: {
            switch (sou_scene_mode) {
                case 2: {
                    sou_chime_volume = 0.45f;
                    NA_COMMAND_AUDIO_GRP_FADE_VOLUME_SCALE(2, 1.f);
                } break;
                default: {
                    sou_chime_volume = 1.f;
                } break;
            }
        } break;
        case 1: {
            switch (sou_scene_mode) {
                case 2: {
                    NA_COMMAND_AUDIO_GRP_FADE_VOLUME_SCALE(2, 0.f);
                    sou_chime_volume = 0.35f;
                } break;
                default: {
                    sou_chime_volume = 0.45f;
                } break;
            }
        } break;
    }
    sou_pause_flag = pauseFlag;
}

extern void Na_RhythmPos(u32 index, u8 unused, u16 angle, f32 distance) {
    u8 pan = 0;
    u8 subtrack = 0;
    f32 volume = 0.f;
    if (sou_sub_game_flag != 1) {
        if (distance > SOU_ONGEN_AREA1) {
            distance = SOU_ONGEN_AREA1;
        }
        pan = angle2pan(angle, distance);
        volume = distance2vol(distance);
        subtrack = Na_GetRhythmSubTrack(index);
        NA_COMMAND_AUDIO_SUBTRACK_SET_VOL_SCALE(2, subtrack, volume);
        NA_COMMAND_AUDIO_SUBTRACK_SET_PAN(2, subtrack, pan);
    }
}

extern void Na_SpecChange(int a) {
    if (a != sou_now_spec) {
        NA_COMMAND_AUDIO_STOP_SEQ(4, 0);
        NA_COMMAND_AUDIO_CLEAR_STAY_CACHE(0);
        NA_COMMAND_AUDIO_CLEAR_STAY_CACHE(1);
        switch (a) {
            case 2:
            case 5:
            case 7:
            case 9: {
                sou_now_voice_seq = 1;
                NA_COMMAND_AUDIO_START_SEQ(4, 0xf3, 0);
            } break;
            case 3: {
                sou_now_voice_seq = 2;
                NA_COMMAND_AUDIO_START_SEQ(4, 0xf4, 0);
            } break;
            case 4:
            case 6:
            case 8: {
                sou_now_voice_seq = 3;
                NA_COMMAND_AUDIO_START_SEQ(4, 0xf5, 0);
            } break;
        }
        sou_now_spec = a;
    }
}

extern void Na_MDPlayerPos(u16 angle, f32 distance, u16 b, u16 c, u32 id) {
    u8 pan = 0;
    f32 volume = 0.f;
    u8 filterStatus = 0;
    if (sou_sub_game_flag != 1) {
        switch (c) {
            case 1:
            case 2:
            case 3:
            case 4:
            case 5: {
                filterStatus = 0x30;
                sou_md_bgm_boost_pasent = 1.08f;
                Na_OngenPos(id, 0x4e, angle, distance);
            } break;
            case 6:
            case 7:
            case 8: {
                filterStatus = 0xe3;
                sou_md_bgm_boost_pasent = 1.4f;
            } break;
            case 9:
            case 0xa:
            case 0xb:
            case 0xc:
            case 0xd:
            case 0xe:
            case 0xf:
            case 0x10: {
                sou_md_bgm_boost_pasent = 1.f;
                filterStatus = 0;
            } break;
        }
        Na_BGMFilter(filterStatus);
        pan = angle2pan(angle, distance);
        volume = distance2vol4MD(distance);
        if (sou_pause_flag == 1) {
            volume = volume * 0.5f;
        }
        volume *= sou_md_bgm_boost_pasent;
        Sou_GroupControl_MD(1, pan, volume);
        Sou_GroupControl_MD(3, pan, volume);
    }
}

extern void Na_BGMVolume(f32 volumeScale, u16 timer) {
    if (volumeScale > 1.f) {
        volumeScale = 1.f;
    }
    if (volumeScale < 0.f) {
        volumeScale = 0.f;
    }
    if (timer > 0x7fff) {
        timer = 0x7fff;
    }
    if (timer == 0) {
        NA_COMMAND_AUDIO_GRP_FADE_VOLUME_SCALE(1, volumeScale);
        NA_COMMAND_AUDIO_GRP_FADE_VOLUME_SCALE(3, volumeScale);
        sou_bgm1_vol_now = volumeScale;
        sou_bgm2_vol_now = volumeScale;
        sou_bgm_vol_move_time = 0;
        sou_bgm_vol_move_counter = 0;
    } else {
        sou_bgm_vol_move_target = volumeScale;
        sou_bgm_vol_move_time = timer;
        sou_bgm_vol_move_counter = timer;
    }
}

extern void Na_RestartPrepare() {
    sou_NeosBootCheck_ok = 0;
    Nap_FlushPort();
    u32 unused = Nap_StartSpecChange(0);
    u32 unused2 = Nap_SendStart();
}

extern u8 Na_CheckRestartReady() {
    return Nap_CheckSpecChange();
}

extern void Na_Restart() {
    if (sou_NeosBootCheck_ok == 0) {
        sou_NeosBootCheck_ok = 2;
        Na_GameFrame();
    }
}

extern u8 Na_SubGameOK() {
    u8 ret = 0;
    if (AG.groups[1].flags.enabled == 0 && AG.groups[3].flags.enabled == 0 && AG.groups[0].flags.enabled == 0) {
        ret = 1;
    } else {
        ret = 0;
    }
    return ret;
}

extern void Na_KishaStatusTrg(u8 a) {
    if (sou_scene_mode != 6) {
        switch (a) {
            case 0: {
                sou_kisha_status = 1;
            } break;
            case 1: {
                sou_kisha_status = 2;
                if (sou_scene_mode == 2 || sou_scene_mode == 0xe) {
                    Na_OngenTrgStart(0x6e, sou_kisha_angle, sou_kisha_distance);
                } else {
                    Na_OngenTrgStart(0x70, sou_kisha_angle, sou_kisha_distance);
                }
            } break;
            case 2: {
                sou_kisha_status = 3;
                Na_OngenTrgStart(0x73, sou_kisha_angle, sou_kisha_distance);
            } break;
            case 3: {
                sou_kisha_status = 4;
                if (sou_scene_mode == 2 || sou_scene_mode == 0xe) {
                    Na_OngenTrgStart(0x6f, sou_kisha_angle, sou_kisha_distance);
                } else {
                    Na_OngenTrgStart(0x71, sou_kisha_angle, sou_kisha_distance);
                }
            } break;
            case 4: {
                sou_kisha_status = 0;
            } break;
        }
    }
}

extern void Na_KishaStatusLevel(f32 speed, u32 ongenNum1, u16 angle1, f32 distance1, u32 ongenNum2, u16 angle2,
                                f32 distance2) {
    f32 f30 = 0.f;
    f32 f29 = 0.f;
    sou_kisha_angle = angle1;
    sou_kisha_distance = distance1;
    sou_kisha_angle2 = angle2;
    sou_kisha_distance2 = distance2;
    if (sou_kisha_status != 0) {
        Na_OngenPos(ongenNum1, 0x10, angle1, distance1);
        f30 = 20.f - 2.5f * speed;
        f29 = 90.f - 11.5f * speed;
        if (sou_shu_count == 4 && speed > 0.4f) {
            Na_OngenTrgStart(0x3b, angle1, distance1);
        }
        if (sou_tonton_count == 10 && speed > 0.4f) {
            Na_OngenTrgStart(0x3f, angle2, distance2);
        }
        if (sou_shu_count > (u16)f30) {
            sou_shu_count = 0;
        }
        if (sou_tonton_count > (u16)f29) {
            sou_tonton_count = 0;
        }
        sou_shu_count++;
        sou_tonton_count++;
    }
}

extern void Na_TTKK_ARM(u8 a) {
    if (sou_now_bgm_num == 0x2b) {
        if (a == 0) {
            NA_COMMAND_AUDIO_SUBTRACK_SET_MUTE(sou_now_bgm_handle, 0, FALSE);
            NA_COMMAND_AUDIO_SUBTRACK_SET_MUTE(sou_now_bgm_handle, 1, FALSE);
            NA_COMMAND_AUDIO_SUBTRACK_SET_MUTE(sou_now_bgm_handle, 2, FALSE);
        } else {
            NA_COMMAND_AUDIO_SUBTRACK_SET_MUTE(sou_now_bgm_handle, 0, TRUE);
            NA_COMMAND_AUDIO_SUBTRACK_SET_MUTE(sou_now_bgm_handle, 1, TRUE);
            NA_COMMAND_AUDIO_SUBTRACK_SET_MUTE(sou_now_bgm_handle, 2, TRUE);
        }
    }
}

extern void Na_BgmMuteClear() {
    u8 unused = 0;
    if (sou_now_bgm_handle == 1) {
        NA_COMMAND_AUDIO_GROUP_SET_APPLY_SUBTRACK_MASK(1, AUDIO_GROUP_ALL_SUBTRACKS);
        NA_COMMAND_AUDIO_SUBTRACK_SET_MUTE(1, AUDIOCMD_ALL_SUBTRACKS, FALSE);

    } else {
        NA_COMMAND_AUDIO_GROUP_SET_APPLY_SUBTRACK_MASK(3, AUDIO_GROUP_ALL_SUBTRACKS);
        NA_COMMAND_AUDIO_SUBTRACK_SET_MUTE(3, AUDIOCMD_ALL_SUBTRACKS, FALSE);
    }
}

extern u8 Na_BgmFadeoutCheck() {
    u8 ret = 0;
    if (AG.groups[1].flags.enabled == 0 && AG.groups[3].flags.enabled == 0) {
        ret = 1;
    } else {
        ret = 0;
    }
    return ret;
}

extern u8 Na_SeFadeoutCheck() {
    u8 i = 0;
    u8 ret = 1;
    if (sou_se_fadeout_flag == 0) {
        return 1;
    }
    for (i = 0; i < ARRAY_COUNT(sou_se_fade); i++) {
        if (sou_se_fade[i]._0) {
            ret = 0;
        }
    }
    if (ret == 1) {
        sou_se_fadeout_flag = 2;
    }
    return ret;
}

__declspec(export) extern void Na_BgmTrOn(u8 subTrack) {
    NA_COMMAND_AUDIO_SUBTRACK_SET_MUTE(sou_now_bgm_handle, subTrack, FALSE);
}

__declspec(export) extern void Na_BgmTrOff(u8 subTrack) {
    NA_COMMAND_AUDIO_SUBTRACK_SET_MUTE(sou_now_bgm_handle, subTrack, TRUE);
}

extern void Na_SubGameStart() {
    sou_sub_game_flag = 1;
    sou_NeosBootCheck_ok = 4;
    u32 unused = Nap_SendStart();
}

extern void Na_SubGameEnd() {
    sou_NeosBootCheck_ok = 3;
    u32 unused = Nap_SendStart();
}

extern void Na_SceneMode(u8 a) {
    u8 unused = 0;
    if (a != sou_scene_mode) {
        sou_ongenpos_kill_countdown = 0;
        sou_se_fadeout_flag = 0;
        switch (a) {
            case 0: {
                sou_chime_volume = 0.f;
                sou_chime_status = 0;
                switch (sou_scene_mode) {
                    case 1:
                    case 3:
                        break;
                    case 0xb: {
                        NA_COMMAND_AUDIO_START_SEQ(0, 0xf2, 0);
                    } break;
                }
            } break;
            case 1: {
                Na_TrgSeEcho(0);
                Na_LevSeEcho(0);
                na_melody_id_hist[0] = -1;
                na_melody_id_hist[1] = -1;
                Na_BGMVolume(1.f, 0);
                NA_COMMAND_AUDIO_STOP_SEQ(2, 0);
                sou_chime_volume = 1.f;
                sou_chime_status = 1;
                switch (sou_scene_mode) {
                    case 8:
                    case 9: {
                    } break;
                    case 1:
                    case 2:
                    case 3:
                    case 4:
                    default:
                    case 7: {
                        Sou_lev_ongen_data_struct_clear();
                        Sou_SeVolumeReset();
                    } break;
                    case 0: {
                        Sou_lev_ongen_data_struct_clear();
                        Sou_SeVolumeReset();
                        NA_COMMAND_AUDIO_START_SEQ(0, 0xf2, 0);
                    } break;
                    case 6:
                    case 5: {
                        Sou_lev_ongen_data_struct_clear();
                        Sou_SeVolumeReset();
                        NA_COMMAND_AUDIO_START_SEQ(0, 0xf2, 0);
                        int unused = Nap_SendStart();
                    } break;
                }
            } break;
            case 0xf:
            case 0x10: {
                Na_TrgSeEcho(1);
                Na_LevSeEcho(1);
                sou_chime_volume = 0.45f;
                sou_chime_status = 1;
                Sou_lev_ongen_data_struct_clear();
                Sou_SeVolumeReset();
            } break;
            case 2:
            case 0xa: {
                switch (sou_scene_mode) {
                    case 0x11: {
                        NA_COMMAND_AUDIO_START_SEQ(0, 0xf2, 0);
                        NA_COMMAND_AUDIO_START_SEQ(2, 0xf6, 0);
                        Sou_lev_ongen_data_struct_clear();
                        Sou_SeVolumeReset();
                        sou_sub_game_flag = 0;
                    } break;
                    default: {
                        sou_chime_volume = 0.45f;
                        sou_chime_status = 1;
                        Sou_lev_ongen_data_struct_clear();
                        Sou_SeVolumeReset();
                        NA_COMMAND_AUDIO_START_SEQ(2, 0xf6, 0);
                        NA_COMMAND_AUDIO_GRP_FADE_VOLUME_SCALE(2, 1.f);
                    } break;
                }
            } break;
            case 3: {
                Sou_lev_ongen_data_struct_clear();
                Sou_SeVolumeReset();
                NA_COMMAND_AUDIO_START_SEQ(0, 0xf2, 0);
                sou_chime_status = 0;
                sou_chime_volume = 0.f;
            } break;
            case 4: {
                NA_COMMAND_AUDIO_START_SEQ(0, 0xf2, 0);
                sou_chime_status = 0;
                sou_chime_volume = 0.f;
            } break;
            case 5: {
                sou_chime_status = 0;
                NA_COMMAND_AUDIO_STOP_SEQ(0, 0xb4);
            } break;
            case 6: {
                sou_chime_status = 0;
                NA_COMMAND_AUDIO_STOP_SEQ(0, 0);
            } break;
            case 7: {
                sou_chime_status = 0;
                sou_chime_volume = 0.f;
            } break;
            case 8:
            case 9: {
                sou_chime_status = 0;
                sou_chime_volume = 0.f;
                NA_COMMAND_AUDIO_START_SEQ(0, 0xf2, 0);
                Sou_lev_ongen_data_struct_clear();
                Sou_SeVolumeReset();
                Na_BGMVolume(1.f, 0);
                NA_COMMAND_AUDIO_STOP_SEQ(2, 0);
            } break;
            case 0xb:
            case 0x12: {
                sou_chime_status = 0;
                NA_COMMAND_AUDIO_STOP_SEQ(0, 0x168);
            } break;
            case 0xc: {
                sou_ongenpos_kill_countdown = 0x46;
                Sou_SeFadeout(0x46);
                switch (sou_scene_mode) {
                    case 0xd: {
                        sou_chime_status = 0;
                    } break;
                }
            } break;
            case 0xd: {
                sou_chime_status = 1;
                sou_ongenpos_kill_countdown = 0x46;
            } break;
            case 0xe: {
                sou_ongenpos_kill_countdown = 0x1e;
                sou_chime_status = 1;
                NA_COMMAND_AUDIO_STOP_SEQ(2, 0xd8);
                Sou_SeFadeout(0x23);
                Na_BgmStop(0xd8);
            } break;
            case 0x11: {
                NA_COMMAND_AUDIO_STOP_SEQ(1, 0x168);
                NA_COMMAND_AUDIO_STOP_SEQ(3, 0x168);
                NA_COMMAND_AUDIO_STOP_SEQ(0, 0xb4);
                NA_COMMAND_AUDIO_STOP_SEQ(2, 0xb4);
            } break;
        }
        sou_scene_mode = a;
    }
}

extern u8 Na_RoomIncectPos(int insectID, u8 index, u16 angle, f32 distance) {
    u8 i = 0;
    u8 foundIndex = 0;
    u8 j = 0;
    u8 r25 = 0;
    u8 found = 0;
    u8 r27 = 0;
    u16 rand = 0;
    u8 r29 = 0;
    u8 r20 = 0;
    u8 ret = FALSE;
    u8 r26 = 0;
    if (sou_sub_game_flag == 1) {
        return ret;
    }
    index = index - 0x36;
    if (sou_scene_mode == 2) {
        r27 = Nap_ReadGrpPort(2, 2);
    } else {
        r27 = (sou_game_frame_counter & (0xf << 3)) >> 3;
    }

    if (r27 > 0xf) {
        r27 = 0;
    }

    for (i = 0; i < ARRAY_COUNT(sou_room_ins); i++) {
        if (insectID == sou_room_ins[i]._00) {
            foundIndex = i;
            i = ARRAY_COUNT(sou_room_ins);
            found = TRUE;
        }
    }

    if (found == FALSE) {
        for (i = 0; i < ARRAY_COUNT(sou_room_ins); i++) {
            if (sou_room_ins[i]._00 == 0) {
                rand = Nap_GetRandom();
                r29 = rand & 0xf;
                r29 = r29 + SE_ROOM_INS_RANDOM_OFFSET[index];

                for (j = 0; j < ARRAY_COUNT(sou_room_ins); j++) {
                    if (r29 == sou_room_ins[j]._07) {
                        r29 = r29 + 1;
                        j = 0;
                        r26++;
                        if (r26 > ARRAY_COUNT(sou_room_ins)) {
                            r26 = 0;
                            j = ARRAY_COUNT(sou_room_ins);
                        }
                    }
                }
                sou_room_ins[i]._07 = r29;
                sou_room_ins[i]._00 = insectID;
                sou_room_ins[i]._04 = 1;
                sou_room_ins[i]._05 = 0;
                sou_room_ins[i]._06 = r27;
                i = ARRAY_COUNT(sou_room_ins);
                for (j = 0; j < ARRAY_COUNT(sou_trg_se); j++) {
                    for (r25 = 0; r25 < ARRAY_COUNT(SE_ROOM_INS_DATA); r25++) {
                        if (sou_trg_se[j]._00 == SE_ROOM_INS_DATA[r25]) {
                            r20 = 1;
                        }
                    }
                }
                if (r20 == 0) {
                    Na_OngenTrgStart(SE_ROOM_INS_DATA[index], angle, distance);
                    ret = TRUE;
                }
            }
        }
    } else {
        if (sou_room_ins[foundIndex]._06 != r27 && sou_room_ins[foundIndex]._07 != 0) {
            switch (r27) {
                case 0:
                case 2:
                case 4:
                case 6:
                case 8:
                case 10:
                case 12:
                case 14: {
                    if (sou_room_ins[foundIndex]._07 == 1) {
                        Na_OngenTrgStart(SE_ROOM_INS_DATA[index], angle, distance);
                        ret = TRUE;
                        rand = Nap_GetRandom();
                        r29 = rand & 0xf;
                        r29 = r29 + SE_ROOM_INS_RANDOM_OFFSET[index];
                        for (j = 0; j < ARRAY_COUNT(sou_room_ins); j++) {
                            if (r29 == sou_room_ins[j]._07) {
                                r29 = r29 + 1;
                                j = 0;
                                r26++;
                                if (r26 > ARRAY_COUNT(sou_room_ins)) {
                                    r26 = 0;
                                    j = ARRAY_COUNT(sou_room_ins);
                                }
                            }
                        }
                        sou_room_ins[foundIndex]._07 = r29;
                    }
                    sou_room_ins[foundIndex]._07--;
                } break;
            }
        }
        sou_room_ins[foundIndex]._04++;
        sou_room_ins[foundIndex]._06 = r27;
    }
    return ret;
}

extern void Na_FurnitureInstPos(int id, u16 angle, f32 distance) {
    u8 i = 0;
    u8 pan = 0;
    f32 volume = 0.f;
    u8 convertedID = 0;
    if (sou_sub_game_flag != 1) {
        for (i = 0; i < ARRAY_COUNT(na_melody_id_hist); i++) {
            if (id == na_melody_id_hist[i]) {
                convertedID = 0xe + i;
                pan = angle2pan(angle, distance);
                volume = distance2vol(distance);
                NA_COMMAND_AUDIO_SUBTRACK_SET_VOL_SCALE(2, convertedID, volume);
                NA_COMMAND_AUDIO_SUBTRACK_SET_PAN(2, convertedID, pan);
                return;
            }
        }
    }
}

extern void Na_TrgSeEcho(u8 echo) {
    u8 i = 0;
    u8 unused = 0;
    for (i = 0; i < ARRAY_COUNT(sou_trg_se); i++) {
        sou_trg_se[i].echo = echo;
    }
}

extern void Na_LevSeEcho(u8 echo) {
    u8 i = 0;
    for (i = 0; i < ARRAY_COUNT(sou_lev_se); i++) {
        sou_lev_se[i].echo = echo;
    }
}

extern void Na_BGMFilter(u8 filterStatus) {
    u8 unused = 0;
    int status = 0;
    s16* firStatus = 0;
    static BOOL init = TRUE;
    u8 unused1 = 0;
    f32 unused2 = 0.f;
    u8 unused3 = 0;
    f32 unused4 = 0.f;
    sou_internal_filter_status = filterStatus;
    if (sou_filter_status != filterStatus) {
        if (init) {
            if (((uintptr_t)&SOU_FIR_STATE_COPY) & 0xf) {
                SOU_FIR_STATE = &SOU_FIR_STATE_COPY[4];
            } else {
                SOU_FIR_STATE = &SOU_FIR_STATE_COPY[0];
            }
            init = FALSE;
        }
        status = filterStatus;
        firStatus = SOU_FIR_STATE;
        if (sou_now_bgm_handle == 1) {
            NA_COMMAND_AUDIO_GROUP_SET_APPLY_SUBTRACK_MASK(1, AUDIO_GROUP_ALL_SUBTRACKS);
            NA_COMMAND_AUDIO_SUBTRACK_SET_FILTER(1, AUDIO_GROUP_ALL_SUBTRACKS, status, firStatus);
        } else {
            NA_COMMAND_AUDIO_GROUP_SET_APPLY_SUBTRACK_MASK(3, AUDIO_GROUP_ALL_SUBTRACKS);
            NA_COMMAND_AUDIO_SUBTRACK_SET_FILTER(3, AUDIO_GROUP_ALL_SUBTRACKS, status, firStatus);
        }
    }
}

extern void Na_RoomType(u8 roomType) {
    if (sou_room_type != roomType) {
        switch (roomType) {
            case 0: {
                SOU_ONGEN_AREA1 = 540.f;
            } break;
            case 1: {
                SOU_ONGEN_AREA1 = 540.f;
                SOU_ONGEN_AREA2 = 545.f;
            } break;
            case 2: {
                SOU_ONGEN_AREA1 = 470.f;
                SOU_ONGEN_AREA2 = 520.f;
            } break;
            case 3: {
                SOU_ONGEN_AREA1 = 510.f;
                SOU_ONGEN_AREA2 = 545.f;
            } break;
        }
        sou_room_type = roomType;
    }
}

extern u8 Na_CheckNeosBoot() {
    return sou_NeosBootCheck_ok == 3 ? TRUE : FALSE;
}

extern void Na_Museum(u8 museumType) {
    if (sou_museum_type != museumType) {
        Na_BgmMuteClear();
        NA_COMMAND_AUDIO_GROUP_SET_APPLY_SUBTRACK_MASK(sou_now_bgm_handle, BGM_MUTE_TABLE_MUSEUM[museumType]);
        NA_COMMAND_AUDIO_SUBTRACK_SET_MUTE(sou_now_bgm_handle, AUDIOCMD_ALL_SUBTRACKS, TRUE);
        sou_museum_type = museumType;
    }
}

extern int Na_GetSoundFrameCounter() {
    return AG.frame_audio_task_count;
}

extern void Na_kazagurumaLevel(f32 kazagurumaSpeed) {
    sou_kazaguruma_speed = kazagurumaSpeed;
}
